
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>More rstat.us Refactoring - Literate Programming</title>
  <meta name="author" content="Steve Klabnik">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  

  <link rel="canonical" href="http://blog.steveklabnik.com/2011/09/23/more-rstat-dot-us-refactoring.html"/>
  <link href="/favicon.png" rel="shortcut icon" />
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="http://s3.amazonaws.com/ender-js/jeesh.min.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="http://feeds.feedburner.com/steveklabnik" rel="alternate" title="Literate Programming" type="application/atom+xml"/>
  <!--Fonts from Google's Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>

</head>

<body  >
  <header><hgroup>
  <h1><a href="/">Literate Programming</a></h1>
  
    <h2>Code is data, data is code. s/data/language/g;</h2>
  
</hgroup>

</header>
  <nav role=navigation><ul role=subscription data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/steveklabnik" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<form action="http://google.com/search" method="get">
  <fieldset role="site-search">
    <input type="hidden" name="q" value="site:blog.steveklabnik.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
<ul role=main-navigation>
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry">
  
  <header>
    
      <h1 class="entry-title">More rstat.us Refactoring</h1>
    
    
      <p class="meta">





  



<time datetime="2011-09-23T17:03:00-04:00" pubdate  data-updated="true" >Sep 23<span>rd</span>, 2011</time></p>
    
  </header>


<div class="entry-content"><p>Hey everyone! I just wanted to share One More Thing with you about this rstat.us
refactoring.</p>

<p>The main thrust of the last article I posted was to show you a technique for
extracting a class, getting it under some kind of test, and then refactoring it
a bit. Refactoring is always an iterative process, and Ryan Bates from the
always awesome <a href="http://railscasts.com">Railscasts</a> asked me why I made the
Salmon class into a module, especially given my recent <a href="/2011/09/06/the-secret-to-rails-oo-design.html">rant</a>
against modules. The answer was, &#8216;because it&#8217;s simpler, and the first thing
I thought of.&#8217; He shared with me an alternate implementation that I like too,
and I wanted to share with you. Check it:</p>

<figure role=code><figcaption><span>app/models/salmon_notifier.rb</span></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
<span class='line'>10</span>
<span class='line'>11</span>
<span class='line'>12</span>
<span class='line'>13</span>
<span class='line'>14</span>
<span class='line'>15</span>
<span class='line'>16</span>
<span class='line'>17</span>
<span class='line'>18</span>
<span class='line'>19</span>
<span class='line'>20</span>
<span class='line'>21</span>
<span class='line'>22</span>
<span class='line'>23</span>
<span class='line'>24</span>
<span class='line'>25</span>
<span class='line'>26</span>
<span class='line'>27</span>
<span class='line'>28</span>
<span class='line'>29</span>
<span class='line'>30</span>
</pre></td><td class='code' width='100%'><pre><code class='ruby'><div class='line'><span class="k">class</span> <span class="nc">SalmonNotifier</span>
</div><div class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">feed</span><span class="p">)</span>
</div><div class='line'>    <span class="vi">@user</span> <span class="o">=</span> <span class="n">user</span>
</div><div class='line'>    <span class="vi">@feed</span> <span class="o">=</span> <span class="n">feed</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'>
</div><div class='line'>  <span class="k">def</span> <span class="nf">mention</span><span class="p">(</span><span class="n">update</span><span class="p">)</span>
</div><div class='line'>    <span class="n">deliver</span> <span class="no">OStatus</span><span class="o">::</span><span class="no">Salmon</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">to_atom</span><span class="p">(</span><span class="s2">&quot;http://</span><span class="si">#{</span><span class="vi">@user</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">domain</span><span class="si">}</span><span class="s2">/&quot;</span><span class="p">))</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'>
</div><div class='line'>  <span class="k">def</span> <span class="nf">follow</span>
</div><div class='line'>    <span class="n">deliver</span> <span class="no">OStatus</span><span class="o">::</span><span class="no">Salmon</span><span class="o">.</span><span class="n">from_follow</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">to_atom</span><span class="p">,</span> <span class="vi">@feed</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">to_atom</span><span class="p">)</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'>
</div><div class='line'>  <span class="k">def</span> <span class="nf">unfollow</span>
</div><div class='line'>    <span class="n">deliver</span> <span class="no">OStatus</span><span class="o">::</span><span class="no">Salmon</span><span class="o">.</span><span class="n">from_unfollow</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">to_atom</span><span class="p">,</span> <span class="vi">@feed</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">to_atom</span><span class="p">)</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'>
</div><div class='line'>  <span class="kp">protected</span>
</div><div class='line'>
</div><div class='line'>  <span class="k">def</span> <span class="nf">deliver</span><span class="p">(</span><span class="n">salmon</span><span class="p">)</span>
</div><div class='line'>    <span class="n">send_envelope_to_salmon_endpoint</span> <span class="n">salmon</span><span class="o">.</span><span class="n">to_xml</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">to_rsa_keypair</span><span class="p">)</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'>
</div><div class='line'>  <span class="k">def</span> <span class="nf">send_envelope_to_salmon_endpoint</span><span class="p">(</span><span class="n">envelope</span><span class="p">)</span>
</div><div class='line'>    <span class="n">uri</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="vi">@feed</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">salmon_url</span><span class="p">)</span>
</div><div class='line'>    <span class="n">http</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">uri</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
</div><div class='line'>    <span class="n">http</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">envelope</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;application/magic-envelope+xml&quot;</span><span class="p">})</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'><span class="k">end</span>
</div></code></pre></td></tr></table></div></figure>


<p>This follows a more OO style, and is a bit more well-factored. Here&#8217;s his
description of what he did:</p>

<blockquote><p>1. Switched to a class and gave it a name that is a noun (maybe name<br/>should be different though).<br/>2. Moved common method params into instance variables.<br/>3. This simplified the mention/follow/unfollow methods enough to be on one line.<br/>4. Renamed &#8220;send_to_salmon_endpoint&#8221; to &#8220;deliver&#8221; because it feels<br/>nicer, the &#8220;salmon endpoint&#8221; can be assumed due to the name of the<br/>class. I generally don&#8217;t like to put the class name in the method<br/>name.<br/>5. Extracted commented out into its own method with the same name. I<br/>don&#8217;t know if this is really necessary though (same reason as above).</p><p>The only thing that bothers me now is the constant access of<br/>@user.author and @feed.author. This makes me think it should be<br/>interacting directly with authors. However you still need access to<br/>@user.to_rsa_keypair but maybe that method could be moved elsewhere<br/>more accessible.</p></blockquote>


<p>All of these changes are pretty good. Ryan&#8217;s suggestions for moving forward are
pretty good, as well, but I&#8217;d add one more thing: we&#8217;re starting to collect a
bunch of methods all related to delivering more generic HTTP requests in the
protected section. This also might be worth pulling out, too.  Protected/private
in general is a minor smell that indicates there&#8217;s code being used multiple
times that&#8217;s not part of the main objective of the class.  It might not be worth
it yet, but then again, it might. Speaking of protected methods, you might
wonder why I ended up mocking out my protected method in the last post, as well.
There are no more tests that actually test the method is working properly.  This
is true, and it&#8217;s because I was leading into thinking of something like this.
Mocked tests are almost always unit tests, and two methods are two separate
units, so I had just ended up doing it out of habit. This further shows that
maybe an extraction of another class is worthwhile.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Steve Klabnik</span></span>

      





  



<time datetime="2011-09-23T17:03:00-04:00" pubdate  data-updated="true" >Sep 23<span>rd</span>, 2011</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://blog.steveklabnik.com/2011/09/23/more-rstat-dot-us-refactoring.html" data-via="steveklabnik" data-counturl="http://blog.steveklabnik.com/2011/09/23/more-rstat-dot-us-refactoring.html" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
</div>

    
  </footer>
</article>

</div>

<aside role=sidebar>
  
    <aside>
<img src='http://en.gravatar.com/userimage/5335489/ee56a7574df33ed8748160494c930b98.jpg?size=190' />
<h4>Hi there, I'm Steve.</h4>
<p>
I write both code and prose. Here's some of my thoughts about software,
literature, art and code, with some politics thrown in on occasion.
You might also enjoy <a href="http://steveklabnik.com/">my website</a>.
</p>
</aside>

<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2011/12/12/fast-rails-tests-with-cancan.html">Fast Rails Tests With CanCan.</a>
      </li>
    
      <li class="post">
        <a href="/2011/12/11/devise-actioncontroller-routingerror-no-route-matches-get-slash-users-slash-sign-out.html">Devise: ActionController::RoutingError (No Route Matches [GET] /users/sign_out)</a>
      </li>
    
      <li class="post">
        <a href="/2011/11/28/book-review-new-programmers-survival-manual.html">Book Review: New Programmer's Survival Manual</a>
      </li>
    
      <li class="post">
        <a href="/2011/11/17/burnout.html">Burnout</a>
      </li>
    
      <li class="post">
        <a href="/2011/10/25/your-startup-is-not-a-platform.html">Your Startup is NOT a Platform</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Github Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/steveklabnik">@steveklabnik</a> on Github
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'steveklabnik',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("steveklabnik", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/steveklabnik" class="twitter-follow-button" data-width="208px" data-show-count="false">Follow @steveklabnik</a>
  
</section>




  
</aside>


    </div>
  </div>
  <footer><p>
  Copyright &copy; 2011 - Steve Klabnik -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-10289851-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


  
  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>


  
  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>


</body>
</html>
