
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Extracting Domain Models: A Practical Example - Literate Programming</title>
  <meta name="author" content="Steve Klabnik">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  

  <link rel="canonical" href="http://blog.steveklabnik.com/2011/09/22/extracting-domain-models-a-practical-example.html"/>
  <link href="/favicon.png" rel="shortcut icon" />
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="http://s3.amazonaws.com/ender-js/jeesh.min.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="http://feeds.feedburner.com/steveklabnik" rel="alternate" title="Literate Programming" type="application/atom+xml"/>
  <!--Fonts from Google's Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>

</head>

<body  >
  <header><hgroup>
  <h1><a href="/">Literate Programming</a></h1>
  
    <h2>Code is data, data is code. s/data/language/g;</h2>
  
</hgroup>

</header>
  <nav role=navigation><ul role=subscription data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/steveklabnik" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<form action="http://google.com/search" method="get">
  <fieldset role="site-search">
    <input type="hidden" name="q" value="site:blog.steveklabnik.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
<ul role=main-navigation>
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry">
  
  <header>
    
      <h1 class="entry-title">Extracting Domain Models: A Practical Example</h1>
    
    
      <p class="meta">





  



<time datetime="2011-09-22T10:25:00-05:00" pubdate  data-updated="true" >Sep 22<span>nd</span>, 2011</time></p>
    
  </header>


<div class="entry-content"><p>Hey everyone! We&#8217;ve been doing a lot of refactoring on rstat.us lately, and I
wanted to share with you a refactoring that I did. It&#8217;s a real-world example
of doing the domain models concept that I&#8217;ve been talking about lately.</p>

<h2>Step one: check the tests</h2>

<blockquote><p>I don&#8217;t know how much more emphasized step 1 of refactoring could be: don&#8217;t touch anything that doesn&#8217;t have coverage. Otherwise, you&#8217;re not refactoring; you&#8217;re just changing shit.
- Hamlet D&#8217;Arcy</p></blockquote>

<p>One of the best reasons to extract extra domain models is that they&#8217;re often
much easier to test. They have less dependencies, less code, and are much
simpler than the Mega Models that happen if you have a 1-1 model to table
ratio.</p>

<p>Let&#8217;s check out the code. It&#8217;s in our User model:</p>

<figure role=code><figcaption><span>app/models/user.rb </span><a href='https://github.com/hotsh/rstat.us/blob/362cb38031/app/models/user.rb#L209'>link</a></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
<span class='line'>10</span>
<span class='line'>11</span>
<span class='line'>12</span>
<span class='line'>13</span>
<span class='line'>14</span>
<span class='line'>15</span>
</pre></td><td class='code' width='100%'><pre><code class='ruby'><div class='line'><span class="c1"># Send an update to a remote user as a Salmon notification</span>
</div><div class='line'><span class="k">def</span> <span class="nf">send_mention_notification</span> <span class="n">update_id</span><span class="p">,</span> <span class="n">to_feed_id</span>
</div><div class='line'>  <span class="n">f</span> <span class="o">=</span> <span class="no">Feed</span><span class="o">.</span><span class="n">first</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">to_feed_id</span>
</div><div class='line'>  <span class="n">u</span> <span class="o">=</span> <span class="no">Update</span><span class="o">.</span><span class="n">first</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">update_id</span>
</div><div class='line'>
</div><div class='line'>  <span class="n">base_uri</span> <span class="o">=</span> <span class="s2">&quot;http://</span><span class="si">#{</span><span class="n">author</span><span class="o">.</span><span class="n">domain</span><span class="si">}</span><span class="s2">/&quot;</span>
</div><div class='line'>  <span class="n">salmon</span> <span class="o">=</span> <span class="no">OStatus</span><span class="o">::</span><span class="no">Salmon</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">to_atom</span><span class="p">(</span><span class="n">base_uri</span><span class="p">))</span>
</div><div class='line'>
</div><div class='line'>  <span class="n">envelope</span> <span class="o">=</span> <span class="n">salmon</span><span class="o">.</span><span class="n">to_xml</span> <span class="nb">self</span><span class="o">.</span><span class="n">to_rsa_keypair</span>
</div><div class='line'>
</div><div class='line'>  <span class="c1"># Send envelope to Author&#39;s Salmon endpoint</span>
</div><div class='line'>  <span class="n">uri</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">salmon_url</span><span class="p">)</span>
</div><div class='line'>  <span class="n">http</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">uri</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
</div><div class='line'>  <span class="n">res</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">envelope</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;application/magic-envelope+xml&quot;</span><span class="p">})</span>
</div><div class='line'><span class="k">end</span>
</div></code></pre></td></tr></table></div></figure>


<p>You&#8217;re probably saying &#8220;this is pretty reasonable.&#8221; Prepare to get shocked&#8230;</p>

<p>This code has very little to do with the user, other than using some of the
User&#8217;s attributes. This really could be factored out into a domain object
whose job it is to push Salmon notifications. But first, let&#8217;s see if we can get
some tests in place so we know <em>everything</em> isn&#8217;t broken. Examining this method,
we need two things: an <code>update_id</code> and a <code>feed_id</code>. Here&#8217;s my first stab at an
integration test:</p>

<figure role=code><figcaption><span>test/models/notify_via_salmon_test.rb</span></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
<span class='line'>10</span>
<span class='line'>11</span>
<span class='line'>12</span>
<span class='line'>13</span>
<span class='line'>14</span>
<span class='line'>15</span>
</pre></td><td class='code' width='100%'><pre><code class='ruby'><div class='line'><span class="n">describe</span> <span class="s2">&quot;salmon update&quot;</span> <span class="k">do</span>
</div><div class='line'>  <span class="n">it</span> <span class="s2">&quot;integration regression test&quot;</span> <span class="k">do</span>
</div><div class='line'>    <span class="n">feed</span> <span class="o">=</span> <span class="no">Feed</span><span class="o">.</span><span class="n">create</span>
</div><div class='line'>    <span class="n">update</span> <span class="o">=</span> <span class="no">Update</span><span class="o">.</span><span class="n">create</span>
</div><div class='line'>
</div><div class='line'>    <span class="n">salmon</span> <span class="o">=</span> <span class="n">double</span><span class="p">(</span><span class="ss">:to_xml</span> <span class="o">=&gt;</span> <span class="s2">&quot;&lt;xml&gt;&lt;/xml&gt;&quot;</span><span class="p">)</span>
</div><div class='line'>    <span class="n">uri</span> <span class="o">=</span> <span class="n">double</span><span class="p">(</span><span class="ss">:host</span> <span class="o">=&gt;</span> <span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="ss">:port</span> <span class="o">=&gt;</span> <span class="s2">&quot;9001&quot;</span><span class="p">,</span> <span class="ss">:path</span> <span class="o">=&gt;</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
</div><div class='line'>    <span class="no">Ostatus</span><span class="o">::</span><span class="no">Salmon</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:new</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="n">salmon</span><span class="p">)</span>
</div><div class='line'>    <span class="no">Uri</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:parse</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
</div><div class='line'>    <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:new</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="n">mock</span><span class="p">(</span><span class="ss">:post</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">))</span>
</div><div class='line'>
</div><div class='line'>    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create</span>
</div><div class='line'>    <span class="n">user</span><span class="o">.</span><span class="n">send_mention_notification</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">feed</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'><span class="k">end</span>
</div></code></pre></td></tr></table></div></figure>


<p>This is an integration test, we&#8217;re obviously testing stuff with a ton of models.
After running <code>ruby test/models/notify_via_salmon.rb</code> about a zillion times, I
ended up with this running test:</p>

<figure role=code><figcaption><span>test/models/notify_via_salmon.rb</span></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
<span class='line'>10</span>
<span class='line'>11</span>
<span class='line'>12</span>
<span class='line'>13</span>
<span class='line'>14</span>
<span class='line'>15</span>
<span class='line'>16</span>
<span class='line'>17</span>
<span class='line'>18</span>
<span class='line'>19</span>
<span class='line'>20</span>
<span class='line'>21</span>
<span class='line'>22</span>
<span class='line'>23</span>
<span class='line'>24</span>
<span class='line'>25</span>
<span class='line'>26</span>
<span class='line'>27</span>
<span class='line'>28</span>
<span class='line'>29</span>
<span class='line'>30</span>
<span class='line'>31</span>
<span class='line'>32</span>
<span class='line'>33</span>
<span class='line'>34</span>
<span class='line'>35</span>
<span class='line'>36</span>
<span class='line'>37</span>
<span class='line'>38</span>
<span class='line'>39</span>
<span class='line'>40</span>
</pre></td><td class='code' width='100%'><pre><code class='ruby'><div class='line'><span class="nb">require</span> <span class="s1">&#39;minitest/autorun&#39;</span>
</div><div class='line'><span class="nb">require</span> <span class="s1">&#39;rspec/mocks&#39;</span>
</div><div class='line'>
</div><div class='line'><span class="nb">require</span> <span class="s1">&#39;mongo_mapper&#39;</span>
</div><div class='line'><span class="nb">require</span> <span class="s1">&#39;whatlanguage&#39;</span>
</div><div class='line'><span class="no">MongoMapper</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Connection</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;localhost&quot;</span><span class="p">)</span>
</div><div class='line'><span class="no">MongoMapper</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="s1">&#39;rstatus-test&#39;</span>
</div><div class='line'>
</div><div class='line'><span class="n">require_relative</span> <span class="s1">&#39;../../app/models/feed&#39;</span>
</div><div class='line'><span class="n">require_relative</span> <span class="s1">&#39;../../app/models/update&#39;</span>
</div><div class='line'><span class="n">require_relative</span> <span class="s1">&#39;../../app/models/author&#39;</span>
</div><div class='line'><span class="n">require_relative</span> <span class="s1">&#39;../../app/models/authorization&#39;</span>
</div><div class='line'>
</div><div class='line'><span class="vg">$:</span><span class="o">.</span><span class="n">unshift</span><span class="p">(</span><span class="s2">&quot;lib&quot;</span><span class="p">)</span>
</div><div class='line'><span class="n">require_relative</span> <span class="s1">&#39;../../app/models/user&#39;</span>
</div><div class='line'>
</div><div class='line'><span class="nb">require</span> <span class="s1">&#39;ostatus&#39;</span>
</div><div class='line'>
</div><div class='line'><span class="n">describe</span> <span class="s2">&quot;salmon update&quot;</span> <span class="k">do</span>
</div><div class='line'>  <span class="n">before</span> <span class="ss">:each</span> <span class="k">do</span>
</div><div class='line'>    <span class="no">User</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">each</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:destroy</span><span class="p">)</span>
</div><div class='line'>    <span class="no">RSpec</span><span class="o">::</span><span class="no">Mocks</span><span class="o">::</span><span class="n">setup</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'>
</div><div class='line'>  <span class="n">it</span> <span class="s2">&quot;integration regression test&quot;</span> <span class="k">do</span>
</div><div class='line'>    <span class="n">author</span> <span class="o">=</span> <span class="no">Author</span><span class="o">.</span><span class="n">create</span>
</div><div class='line'>    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">:username</span> <span class="o">=&gt;</span> <span class="s2">&quot;steve&quot;</span><span class="p">,</span> <span class="ss">:author</span> <span class="o">=&gt;</span> <span class="n">author</span><span class="p">)</span>
</div><div class='line'>
</div><div class='line'>    <span class="n">feed</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">feed</span>
</div><div class='line'>    <span class="n">update</span> <span class="o">=</span> <span class="no">Update</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">:feed_id</span> <span class="o">=&gt;</span> <span class="n">feed</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="ss">:author_id</span> <span class="o">=&gt;</span> <span class="n">author</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s2">&quot;hello world&quot;</span><span class="p">)</span>
</div><div class='line'>
</div><div class='line'>    <span class="n">salmon</span> <span class="o">=</span> <span class="n">double</span><span class="p">(</span><span class="ss">:to_xml</span> <span class="o">=&gt;</span> <span class="s2">&quot;&lt;xml&gt;&lt;/xml&gt;&quot;</span><span class="p">)</span>
</div><div class='line'>    <span class="n">uri</span> <span class="o">=</span> <span class="n">double</span><span class="p">(</span><span class="ss">:host</span> <span class="o">=&gt;</span> <span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="ss">:port</span> <span class="o">=&gt;</span> <span class="s2">&quot;9001&quot;</span><span class="p">,</span> <span class="ss">:path</span> <span class="o">=&gt;</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
</div><div class='line'>    <span class="no">OStatus</span><span class="o">::</span><span class="no">Salmon</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:new</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="n">salmon</span><span class="p">)</span>
</div><div class='line'>    <span class="no">URI</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:parse</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
</div><div class='line'>    <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:new</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="n">mock</span><span class="p">(</span><span class="ss">:post</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">))</span>
</div><div class='line'>
</div><div class='line'>    <span class="n">user</span><span class="o">.</span><span class="n">send_mention_notification</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">feed</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'><span class="k">end</span>
</div></code></pre></td></tr></table></div></figure>


<p>Holy. Fuck. Seriously. Let me just quote <a href="http://avdi.org">Avdi Grimm</a>:</p>

<blockquote><p>Mocks, and to some degree RSpec, are like the Hydrogen Peroxide of programming: they fizz up where they encounter subtle technical debt.</p><footer><strong>Avdi Grimm,</strong><cite><a href='http://avdi.org/devblog/2011/04/07/rspec-is-for-the-literate/'>&#8220;Rspec Is for the Literate&#8221;</a></cite></footer></blockquote>


<p>This test class is insane. It runs faster than many people&#8217;s integration tests,
clocking in at about 0.4 seconds. But that&#8217;s still an order of magnitude slower
than I&#8217;d like. A suite with 200 tests would still take over a minute. Also, look
at all this junk that we have to do for setup.</p>

<p>All of this pain and effort doesn&#8217;t mean that testing sucks: it means that our
implementation is terrible. So let&#8217;s use that to guide us. We&#8217;ll try to fix this
code by eliminating all of this junk.</p>

<h2>Step two: simple extraction</h2>

<p>First, let&#8217;s extract this out to a domain model. Here&#8217;s the new code:</p>

<figure role=code><figcaption><span>app/models/user.rb</span></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
</pre></td><td class='code' width='100%'><pre><code class='ruby'><div class='line'><span class="c1"># Send an update to a remote user as a Salmon notification</span>
</div><div class='line'><span class="k">def</span> <span class="nf">send_mention_notification</span> <span class="n">update_id</span><span class="p">,</span> <span class="n">to_feed_id</span>
</div><div class='line'>  <span class="no">NotifyViaSalmon</span><span class="o">.</span><span class="n">mention</span><span class="p">(</span><span class="n">update_id</span><span class="p">,</span> <span class="n">to_feed_id</span><span class="p">)</span>
</div><div class='line'><span class="k">end</span>
</div></code></pre></td></tr></table></div></figure>




<figure role=code><figcaption><span>app/models/notify_via_salmon.rb</span></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
<span class='line'>10</span>
<span class='line'>11</span>
<span class='line'>12</span>
<span class='line'>13</span>
<span class='line'>14</span>
<span class='line'>15</span>
<span class='line'>16</span>
<span class='line'>17</span>
<span class='line'>18</span>
</pre></td><td class='code' width='100%'><pre><code class='ruby'><div class='line'><span class="k">module</span> <span class="nn">NotifyViaSalmon</span>
</div><div class='line'>  <span class="kp">extend</span> <span class="nb">self</span>
</div><div class='line'>
</div><div class='line'>  <span class="k">def</span> <span class="nf">mention</span><span class="p">(</span><span class="n">update_id</span><span class="p">,</span> <span class="n">to_feed_id</span><span class="p">)</span>
</div><div class='line'>    <span class="n">f</span> <span class="o">=</span> <span class="no">Feed</span><span class="o">.</span><span class="n">first</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">to_feed_id</span>
</div><div class='line'>    <span class="n">u</span> <span class="o">=</span> <span class="no">Update</span><span class="o">.</span><span class="n">first</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">update_id</span>
</div><div class='line'>
</div><div class='line'>    <span class="n">base_uri</span> <span class="o">=</span> <span class="s2">&quot;http://</span><span class="si">#{</span><span class="n">author</span><span class="o">.</span><span class="n">domain</span><span class="si">}</span><span class="s2">/&quot;</span>
</div><div class='line'>    <span class="n">salmon</span> <span class="o">=</span> <span class="no">OStatus</span><span class="o">::</span><span class="no">Salmon</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">to_atom</span><span class="p">(</span><span class="n">base_uri</span><span class="p">))</span>
</div><div class='line'>
</div><div class='line'>    <span class="n">envelope</span> <span class="o">=</span> <span class="n">salmon</span><span class="o">.</span><span class="n">to_xml</span> <span class="nb">self</span><span class="o">.</span><span class="n">to_rsa_keypair</span>
</div><div class='line'>
</div><div class='line'>    <span class="c1"># Send envelope to Author&#39;s Salmon endpoint</span>
</div><div class='line'>    <span class="n">uri</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">salmon_url</span><span class="p">)</span>
</div><div class='line'>    <span class="n">http</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">uri</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
</div><div class='line'>    <span class="n">res</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">envelope</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;application/magic-envelope+xml&quot;</span><span class="p">})</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'><span class="k">end</span>
</div></code></pre></td></tr></table></div></figure>


<p>Now, when we run the test (via <code>ruby test/models/notify_via_salmon_test.rb</code>) we
see an error:</p>

<figure role=code><figcaption><span>app/models/notify_via_salmon.rb</span></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
</pre></td><td class='code' width='100%'><pre><code class='ruby'><div class='line'><span class="mi">1</span><span class="p">)</span> <span class="no">Error</span><span class="p">:</span>
</div><div class='line'><span class="n">test_0001_integration_regression_test</span><span class="p">(</span><span class="no">SalmonUpdateSpec</span><span class="p">):</span>
</div><div class='line'><span class="no">NameError</span><span class="p">:</span> <span class="n">undefined</span> <span class="n">local</span> <span class="n">variable</span> <span class="ow">or</span> <span class="nb">method</span> <span class="sb">`author&#39; for NotifyViaSalmon:Module</span>
</div><div class='line'><span class="sb">    /Users/steveklabnik/src/rstat.us/app/models/notify_via_salmon.rb:8:in `</span><span class="n">mention</span><span class="err">&#39;</span>
</div></code></pre></td></tr></table></div></figure>


<p>This is a form of Lean On The Compiler. This test is now failing because it&#8217;s
relying on stuff that used to be internal to the User, and we don&#8217;t have that
stuff now. After doing this a few times, we&#8217;re left with this:</p>

<figure role=code><figcaption><span>app/models/user.rb</span></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
</pre></td><td class='code' width='100%'><pre><code class='ruby'><div class='line'><span class="c1"># Send an update to a remote user as a Salmon notification</span>
</div><div class='line'><span class="k">def</span> <span class="nf">send_mention_notification</span> <span class="n">update_id</span><span class="p">,</span> <span class="n">to_feed_id</span>
</div><div class='line'>  <span class="no">NotifyViaSalmon</span><span class="o">.</span><span class="n">mention</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="n">update_id</span><span class="p">,</span> <span class="n">to_feed_id</span><span class="p">)</span>
</div><div class='line'><span class="k">end</span>
</div></code></pre></td></tr></table></div></figure>




<figure role=code><figcaption><span>app/models/notify_via_salmon.rb</span></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
<span class='line'>10</span>
<span class='line'>11</span>
<span class='line'>12</span>
<span class='line'>13</span>
<span class='line'>14</span>
<span class='line'>15</span>
<span class='line'>16</span>
<span class='line'>17</span>
<span class='line'>18</span>
</pre></td><td class='code' width='100%'><pre><code class='ruby'><div class='line'><span class="k">module</span> <span class="nn">NotifyViaSalmon</span>
</div><div class='line'>  <span class="kp">extend</span> <span class="nb">self</span>
</div><div class='line'>
</div><div class='line'>  <span class="k">def</span> <span class="nf">mention</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">update_id</span><span class="p">,</span> <span class="n">to_feed_id</span><span class="p">)</span>
</div><div class='line'>    <span class="n">f</span> <span class="o">=</span> <span class="no">Feed</span><span class="o">.</span><span class="n">first</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">to_feed_id</span>
</div><div class='line'>    <span class="n">u</span> <span class="o">=</span> <span class="no">Update</span><span class="o">.</span><span class="n">first</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">update_id</span>
</div><div class='line'>
</div><div class='line'>    <span class="n">base_uri</span> <span class="o">=</span> <span class="s2">&quot;http://</span><span class="si">#{</span><span class="n">user</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">domain</span><span class="si">}</span><span class="s2">/&quot;</span>
</div><div class='line'>    <span class="n">salmon</span> <span class="o">=</span> <span class="no">OStatus</span><span class="o">::</span><span class="no">Salmon</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">to_atom</span><span class="p">(</span><span class="n">base_uri</span><span class="p">))</span>
</div><div class='line'>
</div><div class='line'>    <span class="n">envelope</span> <span class="o">=</span> <span class="n">salmon</span><span class="o">.</span><span class="n">to_xml</span> <span class="n">user</span><span class="o">.</span><span class="n">to_rsa_keypair</span>
</div><div class='line'>
</div><div class='line'>    <span class="c1"># Send envelope to Author&#39;s Salmon endpoint</span>
</div><div class='line'>    <span class="n">uri</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">salmon_url</span><span class="p">)</span>
</div><div class='line'>    <span class="n">http</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">uri</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
</div><div class='line'>    <span class="n">res</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">envelope</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;application/magic-envelope+xml&quot;</span><span class="p">})</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'><span class="k">end</span>
</div></code></pre></td></tr></table></div></figure>


<p>Okay. Now we&#8217;re cooking. We have a test that&#8217;s isolated, yet still does what we
thought it did before.</p>

<h2>Step three: break dependencies</h2>

<p>Next step: let&#8217;s break the hard dependency this method has on both Feed and
Update. We can do this by moving the finds up into the User method instead of
keeping them in the mention method:</p>

<figure role=code><figcaption><span>app/models/user.rb</span></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
</pre></td><td class='code' width='100%'><pre><code class='ruby'><div class='line'><span class="c1"># Send an update to a remote user as a Salmon notification</span>
</div><div class='line'><span class="k">def</span> <span class="nf">send_mention_notification</span> <span class="n">update_id</span><span class="p">,</span> <span class="n">to_feed_id</span>
</div><div class='line'>  <span class="n">feed</span> <span class="o">=</span> <span class="no">Feed</span><span class="o">.</span><span class="n">first</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">to_feed_id</span>
</div><div class='line'>  <span class="n">update</span> <span class="o">=</span> <span class="no">Update</span><span class="o">.</span><span class="n">first</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">update_id</span>
</div><div class='line'>
</div><div class='line'>  <span class="no">NotifyViaSalmon</span><span class="o">.</span><span class="n">mention</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="n">update</span><span class="p">,</span> <span class="n">feed</span><span class="p">)</span>
</div><div class='line'><span class="k">end</span>
</div></code></pre></td></tr></table></div></figure>




<figure role=code><figcaption><span>app/models/notify_via_salmon.rb</span></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
<span class='line'>10</span>
<span class='line'>11</span>
<span class='line'>12</span>
<span class='line'>13</span>
<span class='line'>14</span>
<span class='line'>15</span>
</pre></td><td class='code' width='100%'><pre><code class='ruby'><div class='line'><span class="k">module</span> <span class="nn">NotifyViaSalmon</span>
</div><div class='line'>  <span class="kp">extend</span> <span class="nb">self</span>
</div><div class='line'>
</div><div class='line'>  <span class="k">def</span> <span class="nf">mention</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">update</span><span class="p">,</span> <span class="n">feed</span><span class="p">)</span>
</div><div class='line'>    <span class="n">base_uri</span> <span class="o">=</span> <span class="s2">&quot;http://</span><span class="si">#{</span><span class="n">user</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">domain</span><span class="si">}</span><span class="s2">/&quot;</span>
</div><div class='line'>    <span class="n">salmon</span> <span class="o">=</span> <span class="no">OStatus</span><span class="o">::</span><span class="no">Salmon</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">to_atom</span><span class="p">(</span><span class="n">base_uri</span><span class="p">))</span>
</div><div class='line'>
</div><div class='line'>    <span class="n">envelope</span> <span class="o">=</span> <span class="n">salmon</span><span class="o">.</span><span class="n">to_xml</span> <span class="n">user</span><span class="o">.</span><span class="n">to_rsa_keypair</span>
</div><div class='line'>
</div><div class='line'>    <span class="c1"># Send envelope to Author&#39;s Salmon endpoint</span>
</div><div class='line'>    <span class="n">uri</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">feed</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">salmon_url</span><span class="p">)</span>
</div><div class='line'>    <span class="n">http</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">uri</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
</div><div class='line'>    <span class="n">res</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">envelope</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;application/magic-envelope+xml&quot;</span><span class="p">})</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'><span class="k">end</span>
</div></code></pre></td></tr></table></div></figure>


<p>Okay. Tests passing. Sweet. Now we can try testing <em>just</em> the mention method.
Let&#8217;s try it by killing most of that crap that was in our test:</p>

<figure role=code><figcaption><span>test/models/notify_via_salmon_test.rb</span></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
<span class='line'>10</span>
<span class='line'>11</span>
<span class='line'>12</span>
<span class='line'>13</span>
<span class='line'>14</span>
</pre></td><td class='code' width='100%'><pre><code class='ruby'><div class='line'><span class="nb">require</span> <span class="s1">&#39;minitest/autorun&#39;</span>
</div><div class='line'><span class="nb">require</span> <span class="s1">&#39;rspec/mocks&#39;</span>
</div><div class='line'>
</div><div class='line'><span class="n">require_relative</span> <span class="s1">&#39;../../app/models/notify_via_salmon&#39;</span>
</div><div class='line'>
</div><div class='line'><span class="n">describe</span> <span class="s2">&quot;salmon update&quot;</span> <span class="k">do</span>
</div><div class='line'>  <span class="n">before</span> <span class="ss">:each</span> <span class="k">do</span>
</div><div class='line'>    <span class="no">RSpec</span><span class="o">::</span><span class="no">Mocks</span><span class="o">::</span><span class="n">setup</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'>
</div><div class='line'>  <span class="n">it</span> <span class="s2">&quot;integration regression test&quot;</span> <span class="k">do</span>
</div><div class='line'>    <span class="no">NotifyViaSalmon</span><span class="o">.</span><span class="n">mention</span><span class="p">(</span><span class="n">stub</span><span class="p">,</span> <span class="n">stub</span><span class="p">,</span> <span class="n">stub</span><span class="p">)</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'><span class="k">end</span>
</div></code></pre></td></tr></table></div></figure>


<p>Let&#8217;s try running this and seeing what happens:</p>

<figure role=code><figcaption><span>test/models/notify_via_salmon_test.rb</span></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
</pre></td><td class='code' width='100%'><pre><code class='ruby'><div class='line'><span class="err">$</span> <span class="n">ruby</span> <span class="nb">test</span><span class="o">/</span><span class="n">models</span><span class="o">/</span><span class="n">notify_via_salmon_test</span><span class="o">.</span><span class="n">rb</span>
</div><div class='line'><span class="no">Loaded</span> <span class="n">suite</span> <span class="nb">test</span><span class="o">/</span><span class="n">models</span><span class="o">/</span><span class="n">notify_via_salmon_test</span>
</div><div class='line'><span class="no">Started</span>
</div><div class='line'><span class="n">E</span>
</div><div class='line'><span class="no">Finished</span> <span class="k">in</span> <span class="mi">0</span><span class="o">.</span><span class="mo">000</span><span class="mi">992</span> <span class="n">seconds</span><span class="o">.</span>
</div><div class='line'>
</div><div class='line'>  <span class="mi">1</span><span class="p">)</span> <span class="no">Error</span><span class="p">:</span>
</div><div class='line'><span class="n">test_0001_integration_regression_test</span><span class="p">(</span><span class="no">SalmonUpdateSpec</span><span class="p">):</span>
</div><div class='line'><span class="no">RSpec</span><span class="o">::</span><span class="no">Mocks</span><span class="o">::</span><span class="no">MockExpectationError</span><span class="p">:</span> <span class="no">Stub</span> <span class="n">received</span> <span class="n">unexpected</span> <span class="n">message</span> <span class="ss">:author</span> <span class="n">with</span> <span class="p">(</span><span class="n">no</span> <span class="n">args</span><span class="p">)</span>
</div></code></pre></td></tr></table></div></figure>


<p>First of all, daaaaamn. 0.001 seconds. Nice. Secondly, okay, we are getting some
messages sent to our stubs. Let&#8217;s flesh them out to make things pass:</p>

<figure role=code><figcaption><span>test/models/notify_via_salmon_test.rb</span></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
<span class='line'>10</span>
<span class='line'>11</span>
<span class='line'>12</span>
<span class='line'>13</span>
<span class='line'>14</span>
<span class='line'>15</span>
<span class='line'>16</span>
<span class='line'>17</span>
<span class='line'>18</span>
<span class='line'>19</span>
<span class='line'>20</span>
<span class='line'>21</span>
<span class='line'>22</span>
<span class='line'>23</span>
<span class='line'>24</span>
<span class='line'>25</span>
<span class='line'>26</span>
</pre></td><td class='code' width='100%'><pre><code class='ruby'><div class='line'><span class="nb">require</span> <span class="s1">&#39;minitest/autorun&#39;</span>
</div><div class='line'><span class="nb">require</span> <span class="s1">&#39;rspec/mocks&#39;</span>
</div><div class='line'><span class="nb">require</span> <span class="s1">&#39;ostatus&#39;</span>
</div><div class='line'>
</div><div class='line'><span class="n">require_relative</span> <span class="s1">&#39;../../app/models/notify_via_salmon&#39;</span>
</div><div class='line'>
</div><div class='line'><span class="n">describe</span> <span class="s2">&quot;salmon update&quot;</span> <span class="k">do</span>
</div><div class='line'>  <span class="n">before</span> <span class="ss">:each</span> <span class="k">do</span>
</div><div class='line'>    <span class="no">RSpec</span><span class="o">::</span><span class="no">Mocks</span><span class="o">::</span><span class="n">setup</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'>
</div><div class='line'>  <span class="n">it</span> <span class="s2">&quot;integration regression test&quot;</span> <span class="k">do</span>
</div><div class='line'>    <span class="n">user</span> <span class="o">=</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:author</span> <span class="o">=&gt;</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:domain</span> <span class="o">=&gt;</span> <span class="s2">&quot;foo&quot;</span><span class="p">),</span> <span class="ss">:to_rsa_keypair</span> <span class="o">=&gt;</span> <span class="n">stub</span><span class="p">)</span>
</div><div class='line'>    <span class="n">update</span> <span class="o">=</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:to_atom</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</div><div class='line'>    <span class="n">feed</span> <span class="o">=</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:author</span> <span class="o">=&gt;</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:salmon_url</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
</div><div class='line'>
</div><div class='line'>    <span class="n">salmon</span> <span class="o">=</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:to_xml</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</div><div class='line'>    <span class="no">OStatus</span><span class="o">::</span><span class="no">Salmon</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:new</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="n">salmon</span><span class="p">)</span>
</div><div class='line'>
</div><div class='line'>    <span class="n">uri</span> <span class="o">=</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:host</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="ss">:port</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="ss">:path</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</div><div class='line'>    <span class="no">URI</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:parse</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
</div><div class='line'>    <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:new</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="n">stub</span><span class="p">(</span><span class="ss">:post</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
</div><div class='line'>
</div><div class='line'>    <span class="no">NotifyViaSalmon</span><span class="o">.</span><span class="n">mention</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">update</span><span class="p">,</span> <span class="n">feed</span><span class="p">)</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'><span class="k">end</span>
</div></code></pre></td></tr></table></div></figure>


<p>Okay! Note how similar this looks to the previous test. We&#8217;re still mocking a
bunch of &#8216;external&#8217; stuff. But other than that, our test is pretty simple: we
make three stubs, and we call our mention method.</p>

<h3>Step four: repeat</h3>

<p>We could do some more work on this method. There are a few things that are
a bit smelly: the nested stub of User is not great. The fact that we&#8217;re stubbing
out three external dependencies isn&#8217;t great. But before we get to that, let&#8217;s
check out another method that looks similar:
<code>send_{follow,unfollow}_notification</code>. Here&#8217;s some code:</p>

<figure role=code><figcaption><span>app/models/user.rb </span><a href='https://github.com/hotsh/rstat.us/blob/362cb38031/app/models/user.rb#L167'>link</a></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
<span class='line'>10</span>
<span class='line'>11</span>
<span class='line'>12</span>
<span class='line'>13</span>
<span class='line'>14</span>
<span class='line'>15</span>
<span class='line'>16</span>
<span class='line'>17</span>
<span class='line'>18</span>
<span class='line'>19</span>
<span class='line'>20</span>
<span class='line'>21</span>
<span class='line'>22</span>
<span class='line'>23</span>
<span class='line'>24</span>
<span class='line'>25</span>
<span class='line'>26</span>
<span class='line'>27</span>
<span class='line'>28</span>
<span class='line'>29</span>
</pre></td><td class='code' width='100%'><pre><code class='ruby'><div class='line'><span class="c1"># Send Salmon notification so that the remote user</span>
</div><div class='line'><span class="c1"># knows this user is following them</span>
</div><div class='line'><span class="k">def</span> <span class="nf">send_follow_notification</span> <span class="n">to_feed_id</span>
</div><div class='line'>  <span class="n">f</span> <span class="o">=</span> <span class="no">Feed</span><span class="o">.</span><span class="n">first</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">to_feed_id</span>
</div><div class='line'>
</div><div class='line'>  <span class="n">salmon</span> <span class="o">=</span> <span class="no">OStatus</span><span class="o">::</span><span class="no">Salmon</span><span class="o">.</span><span class="n">from_follow</span><span class="p">(</span><span class="n">author</span><span class="o">.</span><span class="n">to_atom</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">to_atom</span><span class="p">)</span>
</div><div class='line'>
</div><div class='line'>  <span class="n">envelope</span> <span class="o">=</span> <span class="n">salmon</span><span class="o">.</span><span class="n">to_xml</span> <span class="nb">self</span><span class="o">.</span><span class="n">to_rsa_keypair</span>
</div><div class='line'>
</div><div class='line'>  <span class="c1"># Send envelope to Author&#39;s Salmon endpoint</span>
</div><div class='line'>  <span class="n">uri</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">salmon_url</span><span class="p">)</span>
</div><div class='line'>  <span class="n">http</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">uri</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
</div><div class='line'>  <span class="n">res</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">envelope</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;application/magic-envelope+xml&quot;</span><span class="p">})</span>
</div><div class='line'><span class="k">end</span>
</div><div class='line'>
</div><div class='line'><span class="c1"># Send Salmon notification so that the remote user</span>
</div><div class='line'><span class="c1"># knows this user has stopped following them</span>
</div><div class='line'><span class="k">def</span> <span class="nf">send_unfollow_notification</span> <span class="n">to_feed_id</span>
</div><div class='line'>  <span class="n">f</span> <span class="o">=</span> <span class="no">Feed</span><span class="o">.</span><span class="n">first</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">to_feed_id</span>
</div><div class='line'>
</div><div class='line'>  <span class="n">salmon</span> <span class="o">=</span> <span class="no">OStatus</span><span class="o">::</span><span class="no">Salmon</span><span class="o">.</span><span class="n">from_unfollow</span><span class="p">(</span><span class="n">author</span><span class="o">.</span><span class="n">to_atom</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">to_atom</span><span class="p">)</span>
</div><div class='line'>
</div><div class='line'>  <span class="n">envelope</span> <span class="o">=</span> <span class="n">salmon</span><span class="o">.</span><span class="n">to_xml</span> <span class="nb">self</span><span class="o">.</span><span class="n">to_rsa_keypair</span>
</div><div class='line'>
</div><div class='line'>  <span class="c1"># Send envelope to Author&#39;s Salmon endpoint</span>
</div><div class='line'>  <span class="n">uri</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">salmon_url</span><span class="p">)</span>
</div><div class='line'>  <span class="n">http</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">uri</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
</div><div class='line'>  <span class="n">res</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">envelope</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;application/magic-envelope+xml&quot;</span><span class="p">})</span>
</div><div class='line'><span class="k">end</span>
</div></code></pre></td></tr></table></div></figure>


<p>Look familliar? Yep! 90% the same code! We&#8217;ll do the same process to these
methods, just like the other one. Check out this code and test:</p>

<figure role=code><figcaption><span>app/models/user.rb</span></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
<span class='line'>10</span>
<span class='line'>11</span>
<span class='line'>12</span>
<span class='line'>13</span>
<span class='line'>14</span>
<span class='line'>15</span>
<span class='line'>16</span>
<span class='line'>17</span>
<span class='line'>18</span>
<span class='line'>19</span>
<span class='line'>20</span>
<span class='line'>21</span>
<span class='line'>22</span>
<span class='line'>23</span>
</pre></td><td class='code' width='100%'><pre><code class='ruby'><div class='line'><span class="c1"># Send Salmon notification so that the remote user</span>
</div><div class='line'><span class="c1"># knows this user is following them</span>
</div><div class='line'><span class="k">def</span> <span class="nf">send_follow_notification</span> <span class="n">to_feed_id</span>
</div><div class='line'>  <span class="n">feed</span> <span class="o">=</span> <span class="no">Feed</span><span class="o">.</span><span class="n">first</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">to_feed_id</span>
</div><div class='line'>
</div><div class='line'>  <span class="no">NotifyViaSalmon</span><span class="o">.</span><span class="n">follow</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="n">feed</span><span class="p">)</span>
</div><div class='line'><span class="k">end</span>
</div><div class='line'>
</div><div class='line'><span class="c1"># Send Salmon notification so that the remote user</span>
</div><div class='line'><span class="c1"># knows this user has stopped following them</span>
</div><div class='line'><span class="k">def</span> <span class="nf">send_unfollow_notification</span> <span class="n">to_feed_id</span>
</div><div class='line'>  <span class="n">feed</span> <span class="o">=</span> <span class="no">Feed</span><span class="o">.</span><span class="n">first</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">to_feed_id</span>
</div><div class='line'>
</div><div class='line'>  <span class="no">NotifyViaSalmon</span><span class="o">.</span><span class="n">unfollow</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="n">feed</span><span class="p">)</span>
</div><div class='line'><span class="k">end</span>
</div><div class='line'>
</div><div class='line'><span class="c1"># Send an update to a remote user as a Salmon notification</span>
</div><div class='line'><span class="k">def</span> <span class="nf">send_mention_notification</span> <span class="n">update_id</span><span class="p">,</span> <span class="n">to_feed_id</span>
</div><div class='line'>  <span class="n">feed</span> <span class="o">=</span> <span class="no">Feed</span><span class="o">.</span><span class="n">first</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">to_feed_id</span>
</div><div class='line'>  <span class="n">update</span> <span class="o">=</span> <span class="no">Update</span><span class="o">.</span><span class="n">first</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">update_id</span>
</div><div class='line'>
</div><div class='line'>  <span class="no">NotifyViaSalmon</span><span class="o">.</span><span class="n">mention</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="n">update</span><span class="p">,</span> <span class="n">feed</span><span class="p">)</span>
</div><div class='line'><span class="k">end</span>
</div></code></pre></td></tr></table></div></figure>




<figure role=code><figcaption><span>app/models/notify_via_salmon.rb</span></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
<span class='line'>10</span>
<span class='line'>11</span>
<span class='line'>12</span>
<span class='line'>13</span>
<span class='line'>14</span>
<span class='line'>15</span>
<span class='line'>16</span>
<span class='line'>17</span>
<span class='line'>18</span>
<span class='line'>19</span>
<span class='line'>20</span>
<span class='line'>21</span>
<span class='line'>22</span>
<span class='line'>23</span>
<span class='line'>24</span>
<span class='line'>25</span>
<span class='line'>26</span>
<span class='line'>27</span>
<span class='line'>28</span>
<span class='line'>29</span>
<span class='line'>30</span>
<span class='line'>31</span>
<span class='line'>32</span>
<span class='line'>33</span>
<span class='line'>34</span>
<span class='line'>35</span>
<span class='line'>36</span>
<span class='line'>37</span>
</pre></td><td class='code' width='100%'><pre><code class='ruby'><div class='line'><span class="k">module</span> <span class="nn">NotifyViaSalmon</span>
</div><div class='line'>  <span class="kp">extend</span> <span class="nb">self</span>
</div><div class='line'>
</div><div class='line'>  <span class="k">def</span> <span class="nf">mention</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">update</span><span class="p">,</span> <span class="n">feed</span><span class="p">)</span>
</div><div class='line'>    <span class="n">base_uri</span> <span class="o">=</span> <span class="s2">&quot;http://</span><span class="si">#{</span><span class="n">user</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">domain</span><span class="si">}</span><span class="s2">/&quot;</span>
</div><div class='line'>    <span class="n">salmon</span> <span class="o">=</span> <span class="no">OStatus</span><span class="o">::</span><span class="no">Salmon</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">to_atom</span><span class="p">(</span><span class="n">base_uri</span><span class="p">))</span>
</div><div class='line'>
</div><div class='line'>    <span class="n">envelope</span> <span class="o">=</span> <span class="n">salmon</span><span class="o">.</span><span class="n">to_xml</span> <span class="n">user</span><span class="o">.</span><span class="n">to_rsa_keypair</span>
</div><div class='line'>
</div><div class='line'>    <span class="c1"># Send envelope to Author&#39;s Salmon endpoint</span>
</div><div class='line'>    <span class="n">uri</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">feed</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">salmon_url</span><span class="p">)</span>
</div><div class='line'>    <span class="n">http</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">uri</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
</div><div class='line'>    <span class="n">res</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">envelope</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;application/magic-envelope+xml&quot;</span><span class="p">})</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'>
</div><div class='line'>  <span class="k">def</span> <span class="nf">follow</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">feed</span><span class="p">)</span>
</div><div class='line'>    <span class="n">salmon</span> <span class="o">=</span> <span class="no">OStatus</span><span class="o">::</span><span class="no">Salmon</span><span class="o">.</span><span class="n">from_follow</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">to_atom</span><span class="p">,</span> <span class="n">feed</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">to_atom</span><span class="p">)</span>
</div><div class='line'>
</div><div class='line'>    <span class="n">envelope</span> <span class="o">=</span> <span class="n">salmon</span><span class="o">.</span><span class="n">to_xml</span> <span class="n">user</span><span class="o">.</span><span class="n">to_rsa_keypair</span>
</div><div class='line'>
</div><div class='line'>    <span class="c1"># Send envelope to Author&#39;s Salmon endpoint</span>
</div><div class='line'>    <span class="n">uri</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">feed</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">salmon_url</span><span class="p">)</span>
</div><div class='line'>    <span class="n">http</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">uri</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
</div><div class='line'>    <span class="n">res</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">envelope</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;application/magic-envelope+xml&quot;</span><span class="p">})</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'>
</div><div class='line'>  <span class="k">def</span> <span class="nf">unfollow</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">feed</span><span class="p">)</span>
</div><div class='line'>    <span class="n">salmon</span> <span class="o">=</span> <span class="no">OStatus</span><span class="o">::</span><span class="no">Salmon</span><span class="o">.</span><span class="n">from_unfollow</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">to_atom</span><span class="p">,</span> <span class="n">feed</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">to_atom</span><span class="p">)</span>
</div><div class='line'>
</div><div class='line'>    <span class="n">envelope</span> <span class="o">=</span> <span class="n">salmon</span><span class="o">.</span><span class="n">to_xml</span> <span class="n">user</span><span class="o">.</span><span class="n">to_rsa_keypair</span>
</div><div class='line'>
</div><div class='line'>    <span class="c1"># Send envelope to Author&#39;s Salmon endpoint</span>
</div><div class='line'>    <span class="n">uri</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">feed</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">salmon_url</span><span class="p">)</span>
</div><div class='line'>    <span class="n">http</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">uri</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
</div><div class='line'>    <span class="n">res</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">envelope</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;application/magic-envelope+xml&quot;</span><span class="p">})</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'><span class="k">end</span>
</div></code></pre></td></tr></table></div></figure>




<figure role=code><figcaption><span>test/models/notify_via_salmon_test.rb</span></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
<span class='line'>10</span>
<span class='line'>11</span>
<span class='line'>12</span>
<span class='line'>13</span>
<span class='line'>14</span>
<span class='line'>15</span>
<span class='line'>16</span>
<span class='line'>17</span>
<span class='line'>18</span>
<span class='line'>19</span>
<span class='line'>20</span>
<span class='line'>21</span>
<span class='line'>22</span>
<span class='line'>23</span>
<span class='line'>24</span>
<span class='line'>25</span>
<span class='line'>26</span>
<span class='line'>27</span>
<span class='line'>28</span>
<span class='line'>29</span>
<span class='line'>30</span>
<span class='line'>31</span>
<span class='line'>32</span>
<span class='line'>33</span>
<span class='line'>34</span>
<span class='line'>35</span>
<span class='line'>36</span>
<span class='line'>37</span>
<span class='line'>38</span>
<span class='line'>39</span>
<span class='line'>40</span>
<span class='line'>41</span>
<span class='line'>42</span>
<span class='line'>43</span>
<span class='line'>44</span>
<span class='line'>45</span>
<span class='line'>46</span>
<span class='line'>47</span>
<span class='line'>48</span>
<span class='line'>49</span>
<span class='line'>50</span>
<span class='line'>51</span>
<span class='line'>52</span>
<span class='line'>53</span>
<span class='line'>54</span>
</pre></td><td class='code' width='100%'><pre><code class='ruby'><div class='line'><span class="nb">require</span> <span class="s1">&#39;minitest/autorun&#39;</span>
</div><div class='line'><span class="nb">require</span> <span class="s1">&#39;rspec/mocks&#39;</span>
</div><div class='line'><span class="nb">require</span> <span class="s1">&#39;ostatus&#39;</span>
</div><div class='line'>
</div><div class='line'><span class="n">require_relative</span> <span class="s1">&#39;../../app/models/notify_via_salmon&#39;</span>
</div><div class='line'>
</div><div class='line'><span class="n">describe</span> <span class="no">NotifyViaSalmon</span> <span class="k">do</span>
</div><div class='line'>  <span class="n">before</span> <span class="ss">:each</span> <span class="k">do</span>
</div><div class='line'>    <span class="no">RSpec</span><span class="o">::</span><span class="no">Mocks</span><span class="o">::</span><span class="n">setup</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'>
</div><div class='line'>  <span class="n">it</span> <span class="s2">&quot;.mention&quot;</span> <span class="k">do</span>
</div><div class='line'>    <span class="n">user</span> <span class="o">=</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:author</span> <span class="o">=&gt;</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:domain</span> <span class="o">=&gt;</span> <span class="s2">&quot;foo&quot;</span><span class="p">),</span> <span class="ss">:to_rsa_keypair</span> <span class="o">=&gt;</span> <span class="n">stub</span><span class="p">)</span>
</div><div class='line'>    <span class="n">update</span> <span class="o">=</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:to_atom</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</div><div class='line'>    <span class="n">feed</span> <span class="o">=</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:author</span> <span class="o">=&gt;</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:salmon_url</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
</div><div class='line'>
</div><div class='line'>    <span class="n">salmon</span> <span class="o">=</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:to_xml</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</div><div class='line'>    <span class="no">OStatus</span><span class="o">::</span><span class="no">Salmon</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:new</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="n">salmon</span><span class="p">)</span>
</div><div class='line'>
</div><div class='line'>    <span class="n">uri</span> <span class="o">=</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:host</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="ss">:port</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="ss">:path</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</div><div class='line'>    <span class="no">URI</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:parse</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
</div><div class='line'>    <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:new</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="n">stub</span><span class="p">(</span><span class="ss">:post</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
</div><div class='line'>
</div><div class='line'>    <span class="no">NotifyViaSalmon</span><span class="o">.</span><span class="n">mention</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">update</span><span class="p">,</span> <span class="n">feed</span><span class="p">)</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'>
</div><div class='line'>  <span class="n">it</span> <span class="s2">&quot;.follow&quot;</span> <span class="k">do</span>
</div><div class='line'>    <span class="n">user</span> <span class="o">=</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:author</span> <span class="o">=&gt;</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:domain</span> <span class="o">=&gt;</span> <span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="ss">:to_atom</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">),</span> <span class="ss">:to_rsa_keypair</span> <span class="o">=&gt;</span> <span class="n">stub</span><span class="p">)</span>
</div><div class='line'>    <span class="n">feed</span> <span class="o">=</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:author</span> <span class="o">=&gt;</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:salmon_url</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="ss">:to_atom</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
</div><div class='line'>
</div><div class='line'>    <span class="n">salmon</span> <span class="o">=</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:to_xml</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</div><div class='line'>    <span class="no">OStatus</span><span class="o">::</span><span class="no">Salmon</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:from_follow</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="n">salmon</span><span class="p">)</span>
</div><div class='line'>
</div><div class='line'>    <span class="n">uri</span> <span class="o">=</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:host</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="ss">:port</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="ss">:path</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</div><div class='line'>    <span class="no">URI</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:parse</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
</div><div class='line'>    <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:new</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="n">stub</span><span class="p">(</span><span class="ss">:post</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
</div><div class='line'>
</div><div class='line'>    <span class="no">NotifyViaSalmon</span><span class="o">.</span><span class="n">follow</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">feed</span><span class="p">)</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'>
</div><div class='line'>  <span class="n">it</span> <span class="s2">&quot;.unfollow&quot;</span> <span class="k">do</span>
</div><div class='line'>    <span class="n">user</span> <span class="o">=</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:author</span> <span class="o">=&gt;</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:domain</span> <span class="o">=&gt;</span> <span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="ss">:to_atom</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">),</span> <span class="ss">:to_rsa_keypair</span> <span class="o">=&gt;</span> <span class="n">stub</span><span class="p">)</span>
</div><div class='line'>    <span class="n">feed</span> <span class="o">=</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:author</span> <span class="o">=&gt;</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:salmon_url</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="ss">:to_atom</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
</div><div class='line'>
</div><div class='line'>    <span class="n">salmon</span> <span class="o">=</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:to_xml</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</div><div class='line'>    <span class="no">OStatus</span><span class="o">::</span><span class="no">Salmon</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:from_unfollow</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="n">salmon</span><span class="p">)</span>
</div><div class='line'>
</div><div class='line'>    <span class="n">uri</span> <span class="o">=</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:host</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="ss">:port</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="ss">:path</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</div><div class='line'>    <span class="no">URI</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:parse</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
</div><div class='line'>    <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:new</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="n">stub</span><span class="p">(</span><span class="ss">:post</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
</div><div class='line'>
</div><div class='line'>    <span class="no">NotifyViaSalmon</span><span class="o">.</span><span class="n">unfollow</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">feed</span><span class="p">)</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'><span class="k">end</span>
</div></code></pre></td></tr></table></div></figure>


<p>Now we can see some of these patterns start to emerge, eh? All of this stuff is
starting to come together. Let&#8217;s get rid of the URI and Net::HTTP stuff, as it&#8217;s
just straight up identical in all three. Pretty basic Extract Method:</p>

<figure role=code><figcaption><span>app/models/notify_via_salmon.rb</span></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
<span class='line'>10</span>
<span class='line'>11</span>
<span class='line'>12</span>
<span class='line'>13</span>
<span class='line'>14</span>
<span class='line'>15</span>
<span class='line'>16</span>
<span class='line'>17</span>
<span class='line'>18</span>
<span class='line'>19</span>
<span class='line'>20</span>
<span class='line'>21</span>
<span class='line'>22</span>
<span class='line'>23</span>
<span class='line'>24</span>
<span class='line'>25</span>
<span class='line'>26</span>
<span class='line'>27</span>
<span class='line'>28</span>
<span class='line'>29</span>
<span class='line'>30</span>
<span class='line'>31</span>
<span class='line'>32</span>
<span class='line'>33</span>
</pre></td><td class='code' width='100%'><pre><code class='ruby'><div class='line'><span class="k">module</span> <span class="nn">NotifyViaSalmon</span>
</div><div class='line'>  <span class="kp">extend</span> <span class="nb">self</span>
</div><div class='line'>
</div><div class='line'>  <span class="k">def</span> <span class="nf">mention</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">update</span><span class="p">,</span> <span class="n">feed</span><span class="p">)</span>
</div><div class='line'>    <span class="n">base_uri</span> <span class="o">=</span> <span class="s2">&quot;http://</span><span class="si">#{</span><span class="n">user</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">domain</span><span class="si">}</span><span class="s2">/&quot;</span>
</div><div class='line'>    <span class="n">salmon</span> <span class="o">=</span> <span class="no">OStatus</span><span class="o">::</span><span class="no">Salmon</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">to_atom</span><span class="p">(</span><span class="n">base_uri</span><span class="p">))</span>
</div><div class='line'>
</div><div class='line'>    <span class="n">send_to_salmon_endpoint</span><span class="p">(</span><span class="n">salmon</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">to_rsa_keypair</span><span class="p">,</span> <span class="n">feed</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">salmon_url</span><span class="p">)</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'>
</div><div class='line'>  <span class="k">def</span> <span class="nf">follow</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">feed</span><span class="p">)</span>
</div><div class='line'>    <span class="n">salmon</span> <span class="o">=</span> <span class="no">OStatus</span><span class="o">::</span><span class="no">Salmon</span><span class="o">.</span><span class="n">from_follow</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">to_atom</span><span class="p">,</span> <span class="n">feed</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">to_atom</span><span class="p">)</span>
</div><div class='line'>
</div><div class='line'>    <span class="n">send_to_salmon_endpoint</span><span class="p">(</span><span class="n">salmon</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">to_rsa_keypair</span><span class="p">,</span> <span class="n">feed</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">salmon_url</span><span class="p">)</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'>
</div><div class='line'>  <span class="k">def</span> <span class="nf">unfollow</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">feed</span><span class="p">)</span>
</div><div class='line'>    <span class="n">salmon</span> <span class="o">=</span> <span class="no">OStatus</span><span class="o">::</span><span class="no">Salmon</span><span class="o">.</span><span class="n">from_unfollow</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">to_atom</span><span class="p">,</span> <span class="n">feed</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">to_atom</span><span class="p">)</span>
</div><div class='line'>
</div><div class='line'>    <span class="n">send_to_salmon_endpoint</span><span class="p">(</span><span class="n">salmon</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">to_rsa_keypair</span><span class="p">,</span> <span class="n">feed</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">salmon_url</span><span class="p">)</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'>
</div><div class='line'>  <span class="kp">protected</span>
</div><div class='line'>
</div><div class='line'>  <span class="k">def</span> <span class="nf">send_to_salmon_endpoint</span><span class="p">(</span><span class="n">salmon</span><span class="p">,</span> <span class="n">keypair</span><span class="p">,</span> <span class="n">uri</span><span class="p">)</span>
</div><div class='line'>    <span class="n">envelope</span> <span class="o">=</span> <span class="n">salmon</span><span class="o">.</span><span class="n">to_xml</span> <span class="n">keypair</span>
</div><div class='line'>
</div><div class='line'>    <span class="c1"># Send envelope to Author&#39;s Salmon endpoint</span>
</div><div class='line'>    <span class="n">uri</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
</div><div class='line'>    <span class="n">http</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">uri</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
</div><div class='line'>    <span class="n">res</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">envelope</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;application/magic-envelope+xml&quot;</span><span class="p">})</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'><span class="k">end</span>
</div></code></pre></td></tr></table></div></figure>


<p>We run our tests, it still all works. Now we can just mock out the endpoint
method, and all of our tests on the individual methods become much, much simpler:</p>

<figure role=code><figcaption><span>test/models/notify_via_salmon_test.rb</span></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
<span class='line'>10</span>
<span class='line'>11</span>
<span class='line'>12</span>
<span class='line'>13</span>
<span class='line'>14</span>
<span class='line'>15</span>
<span class='line'>16</span>
<span class='line'>17</span>
<span class='line'>18</span>
<span class='line'>19</span>
<span class='line'>20</span>
<span class='line'>21</span>
<span class='line'>22</span>
<span class='line'>23</span>
<span class='line'>24</span>
<span class='line'>25</span>
<span class='line'>26</span>
<span class='line'>27</span>
<span class='line'>28</span>
<span class='line'>29</span>
<span class='line'>30</span>
<span class='line'>31</span>
<span class='line'>32</span>
<span class='line'>33</span>
<span class='line'>34</span>
<span class='line'>35</span>
<span class='line'>36</span>
<span class='line'>37</span>
<span class='line'>38</span>
<span class='line'>39</span>
<span class='line'>40</span>
<span class='line'>41</span>
<span class='line'>42</span>
<span class='line'>43</span>
<span class='line'>44</span>
<span class='line'>45</span>
</pre></td><td class='code' width='100%'><pre><code class='ruby'><div class='line'><span class="nb">require</span> <span class="s1">&#39;minitest/autorun&#39;</span>
</div><div class='line'><span class="nb">require</span> <span class="s1">&#39;rspec/mocks&#39;</span>
</div><div class='line'><span class="nb">require</span> <span class="s1">&#39;ostatus&#39;</span>
</div><div class='line'>
</div><div class='line'><span class="n">require_relative</span> <span class="s1">&#39;../../app/models/notify_via_salmon&#39;</span>
</div><div class='line'>
</div><div class='line'><span class="n">describe</span> <span class="no">NotifyViaSalmon</span> <span class="k">do</span>
</div><div class='line'>  <span class="n">before</span> <span class="ss">:each</span> <span class="k">do</span>
</div><div class='line'>    <span class="no">RSpec</span><span class="o">::</span><span class="no">Mocks</span><span class="o">::</span><span class="n">setup</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'>
</div><div class='line'>  <span class="n">it</span> <span class="s2">&quot;.mention&quot;</span> <span class="k">do</span>
</div><div class='line'>    <span class="n">user</span> <span class="o">=</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:author</span> <span class="o">=&gt;</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:domain</span> <span class="o">=&gt;</span> <span class="s2">&quot;foo&quot;</span><span class="p">),</span> <span class="ss">:to_rsa_keypair</span> <span class="o">=&gt;</span> <span class="n">stub</span><span class="p">)</span>
</div><div class='line'>    <span class="n">update</span> <span class="o">=</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:to_atom</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</div><div class='line'>    <span class="n">feed</span> <span class="o">=</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:author</span> <span class="o">=&gt;</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:salmon_url</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
</div><div class='line'>
</div><div class='line'>    <span class="no">NotifyViaSalmon</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:send_to_salmon_endpoint</span><span class="p">)</span>
</div><div class='line'>
</div><div class='line'>    <span class="no">NotifyViaSalmon</span><span class="o">.</span><span class="n">mention</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">update</span><span class="p">,</span> <span class="n">feed</span><span class="p">)</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'>
</div><div class='line'>  <span class="n">it</span> <span class="s2">&quot;.follow&quot;</span> <span class="k">do</span>
</div><div class='line'>    <span class="n">user</span> <span class="o">=</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:author</span> <span class="o">=&gt;</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:domain</span> <span class="o">=&gt;</span> <span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="ss">:to_atom</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">),</span> <span class="ss">:to_rsa_keypair</span> <span class="o">=&gt;</span> <span class="n">stub</span><span class="p">)</span>
</div><div class='line'>    <span class="n">feed</span> <span class="o">=</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:author</span> <span class="o">=&gt;</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:salmon_url</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="ss">:to_atom</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
</div><div class='line'>
</div><div class='line'>    <span class="n">salmon</span> <span class="o">=</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:to_xml</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</div><div class='line'>    <span class="no">OStatus</span><span class="o">::</span><span class="no">Salmon</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:from_follow</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="n">salmon</span><span class="p">)</span>
</div><div class='line'>
</div><div class='line'>    <span class="no">NotifyViaSalmon</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:send_to_salmon_endpoint</span><span class="p">)</span>
</div><div class='line'>
</div><div class='line'>    <span class="no">NotifyViaSalmon</span><span class="o">.</span><span class="n">follow</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">feed</span><span class="p">)</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'>
</div><div class='line'>  <span class="n">it</span> <span class="s2">&quot;.unfollow&quot;</span> <span class="k">do</span>
</div><div class='line'>    <span class="n">user</span> <span class="o">=</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:author</span> <span class="o">=&gt;</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:domain</span> <span class="o">=&gt;</span> <span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="ss">:to_atom</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">),</span> <span class="ss">:to_rsa_keypair</span> <span class="o">=&gt;</span> <span class="n">stub</span><span class="p">)</span>
</div><div class='line'>    <span class="n">feed</span> <span class="o">=</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:author</span> <span class="o">=&gt;</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:salmon_url</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="ss">:to_atom</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
</div><div class='line'>
</div><div class='line'>    <span class="n">salmon</span> <span class="o">=</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:to_xml</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</div><div class='line'>    <span class="no">OStatus</span><span class="o">::</span><span class="no">Salmon</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:from_unfollow</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="n">salmon</span><span class="p">)</span>
</div><div class='line'>
</div><div class='line'>    <span class="no">NotifyViaSalmon</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:send_to_salmon_endpoint</span><span class="p">)</span>
</div><div class='line'>
</div><div class='line'>    <span class="no">NotifyViaSalmon</span><span class="o">.</span><span class="n">unfollow</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">feed</span><span class="p">)</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'><span class="k">end</span>
</div></code></pre></td></tr></table></div></figure>


<p>We&#8217;ve managed to get rid of all of the mocking of the URI stuff. It&#8217;s all
details now. We also have great information about what is actually needed for
this test: we know exactly what our objects expect the caller to pass. We&#8217;re
only depending on ourselves and some external libraries. Our tests are fast.
Overall, I&#8217;m feeling much better about this code than I was before.</p>

<h2>In conclusion</h2>

<p>I hope you&#8217;ll take a few things away from this post.</p>

<p><strong>Start with tests first!</strong> If you don&#8217;t do this, it&#8217;s very easy to introduce
simple errors. Don&#8217;t be that guy. You know, the one that has to make <a href="https://github.com/hotsh/rstat.us/pull/398/files">pull requests like this&#8230;</a>
I suck.</p>

<p><strong>Don&#8217;t be afraid to change the tests!</strong> As soon as you&#8217;ve verified that you&#8217;ve
transcribed the code correctly, don&#8217;t be afraid to just nuke things and start
again. Especially if you have integration level tests that confirm that your
features actually <em>work</em>, your unit tests are expendable. If they&#8217;re not useful,
kill them!</p>

<p><strong>Mock like a motherfucker.</strong> When done correctly, mocks allow you to help
design your code better, make your tests fast, and truly isolate the unit under
test. It&#8217;s pretty much all upside, unless you suck at them.</p>

<p><strong>Extract, extract, extract!</strong> Adele Goldberg once said, “In Smalltalk,
everything happens somewhere else.” Make tons of little methods. They help
to provide seams that are useful for testing. Smaller methods are also easier to
understand.</p>

<p><strong>Refactoring is a marathon.</strong> Even with all this work, this code isn&#8217;t the best.
The tests could even use a little TLC. But it&#8217;s still better than it was before.
Those who ship, win. Make things a little better, <code>git commit &amp;&amp; git push</code>, repeat.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Steve Klabnik</span></span>

      





  



<time datetime="2011-09-22T10:25:00-05:00" pubdate  data-updated="true" >Sep 22<span>nd</span>, 2011</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://blog.steveklabnik.com/2011/09/22/extracting-domain-models-a-practical-example.html" data-via="steveklabnik" data-counturl="http://blog.steveklabnik.com/2011/09/22/extracting-domain-models-a-practical-example.html" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
</div>

    
  </footer>
</article>

</div>

<aside role=sidebar>
  
    <aside>
<img src='http://en.gravatar.com/userimage/5335489/ee56a7574df33ed8748160494c930b98.jpg?size=190' />
<h4>Hi there, I'm Steve.</h4>
<p>
I write both code and prose. Here's some of my thoughts about software,
literature, art and code, with some politics thrown in on occasion.
You might also enjoy <a href="http://steveklabnik.com/">my website</a>.
</p>
</aside>

<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2011/10/01/github-is-anarchy-for-programmers.html">GitHub Is Anarchy for Programmers</a>
      </li>
    
      <li class="post">
        <a href="/2011/09/28/real-modern-ruby-development.html">(Real) Modern Ruby Development</a>
      </li>
    
      <li class="post">
        <a href="/2011/09/26/im-deleting-my-facebook-tonight.html">I'm Deleting My Facebook Tonight.</a>
      </li>
    
      <li class="post">
        <a href="/2011/09/23/more-rstat-dot-us-refactoring.html">More rstat.us Refactoring</a>
      </li>
    
      <li class="post">
        <a href="/2011/09/22/extracting-domain-models-a-practical-example.html">Extracting Domain Models: A Practical Example</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Github Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/steveklabnik">@steveklabnik</a> on Github
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'steveklabnik',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("steveklabnik", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/steveklabnik" class="twitter-follow-button" data-width="208px" data-show-count="false">Follow @steveklabnik</a>
  
</section>




  
</aside>


    </div>
  </div>
  <footer><p>
  Copyright &copy; 2011 - Steve Klabnik -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-10289851-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


  
  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>


  
  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>


</body>
</html>
