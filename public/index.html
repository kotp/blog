
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Literate Programming</title>
  <meta name="author" content="Steve Klabnik">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  

  <link rel="canonical" href="http://blog.steveklabnik.com/index.html"/>
  <link href="/favicon.png" rel="shortcut icon" />
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="http://s3.amazonaws.com/ender-js/jeesh.min.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="http://feeds.feedburner.com/steveklabnik" rel="alternate" title="Literate Programming" type="application/atom+xml"/>
  <!--Fonts from Google's Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>

</head>

<body  >
  <header><hgroup>
  <h1><a href="/">Literate Programming</a></h1>
  
    <h2>Code is data, data is code. s/data/language/g;</h2>
  
</hgroup>

</header>
  <nav role=navigation><ul role=subscription data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/steveklabnik" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<form action="http://google.com/search" method="get">
  <fieldset role="site-search">
    <input type="hidden" name="q" value="site:blog.steveklabnik.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
<ul role=main-navigation>
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">



  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/2011/11/28/book-review-new-programmers-survival-manual.html">Book Review: New Programmer&#8217;s Survival Manual</a></h1>
    
    
      <p class="meta">





  



<time datetime="2011-11-28T10:10:00-05:00" pubdate  data-updated="true" >Nov 28<span>th</span>, 2011</time></p>
    
  </header>


  <div class="entry-content"><p>Disclaimer: I do have a small credit in this book. A long time ago, the
author mentioned that he was looking for people to help out, so I stepped up.
It was only participating in discussions like &#8220;What do you think about
version control&#8217;s use in industry?&#8221;; I didn&#8217;t help with any actual
writing, and yesterday was my first time reading virtually all the final
content.</p>

<h3>Lots of new books lately</h3>

<p>I&#8217;ve been doing a lot of reading over the last few weeks, some of it
technical, some of it non. I&#8217;ve been meaning to type up a few book
reviews, and yesterday I finished reading my copy of Josh Carter&#8217;s
<a href="http://pragprog.com/book/jcdeg/new-programmer-s-survival-manual">&#8220;New Programmer&#8217;s Survival Manual,&#8221;</a>
published by PragProg. Since that&#8217;s a bit lighter material than Spinoza, I
figured I&#8217;d write it up first.</p>

<p>The <em>Survival Manual</em> is intended to be the book you should buy after you
graduate from college, but before you get a job. It&#8217;s a bunch of tips,
arranged by topic, that give you a taste of what &#8216;real world&#8217; programming is
like, as well as what working life is about. I think that it accomplishes this
goal wonderfully, but if you&#8217;d like to hear specifics, read on.</p>

<h2>The Good</h2>

<p>One of my roommates is not particularly technical. She picked the book up, and
read the introduction and the first tip. She then said something that, after
reading all of it, I agree with 100%. &#8220;I like this guy&#8217;s writing style. It&#8217;s
very&#8230; readable.&#8221; Josh&#8217;s prose feels&#8230; comfortable. Like you&#8217;re talking to a
down-to-earth friend, or co-worker. Which is great, given the topic. I
really enjoyed the actual <em>reading</em> of this book. Especially in technical
books, this is a great quality to have, but I guess this book isn&#8217;t
exactly technical; it&#8217;s much more about soft skills than hard.</p>

<p>I also really enjoyed the cookbook-style organization. Basically, the book is
one big ball of tips that you can read individually. They&#8217;re grouped together
with three or four others that are on the same topic, but each stands alone, and
they cross-reference each other when appropriate. While I sat down and read it
front to back, I&#8217;d imagine it&#8217;s pretty easy to cherry-pick certain things and
read it in a more non-linear fashion.</p>

<p>I also feel that &#8216;pragmatic&#8217; is a good description of most of the content. In
particular, as much as we all love DVCS, the book frankly states that most
places still use centralized version control, which is totally true. He makes
sure to carefully not be particularly dogmatic about the specifics of anything,
focusing on strategy more than tactics. For example, &#8220;Get good with your editor,
make sure it can work effectively without using the mouse, for speed,&#8221; not &#8220;zomg
emacs r teh suck, use vim.&#8221;</p>

<p>Finally, Josh links to copious other works, and provides references for all of
it. Some stuff is just general internet culture, but the bibliography alone
would assist any programmer in finding some useful primary materials to read.
Here&#8217;s the first six: <em>SICP</em>, <em>Getting Things Done</em>, <em>Extreme Programming
Explained</em>, <em>TDD By Example</em>, <em>The Mythical Man-Month</em>, and <em>Foundations of
Object Oriented Languages: Types and Semantics</em>. Oh, and just because there&#8217;s
some XP/Agile stuff in those particular books, don&#8217;t think it&#8217;s slanted towards
that: waterfall is explained as well. Just so happens those books were first.</p>

<h2>The Bad</h2>

<p>There&#8217;s not that much bad that I can say about this book, really. There are a
few small things, though:</p>

<p>There&#8217;s a &#8216;white belt brown belt black belt&#8217; metaphor that&#8217;s supposed to
indicate a difficulty of each tip. Given that there&#8217;s only two black belt tips,
I didn&#8217;t feel that three levels were really needed. I also just thought that
there wasn&#8217;t a huge difference between white and brown, either, so I&#8217;m not sure
that it really adds any utility.</p>

<p>Because this book is fairly high-level, it might be hard to actually <em>apply</em>
these lessons. This might be more of a problem with readers than with the actual
book, but I can&#8217;t count how many times I (and others) have said &#8220;Of course,
write descriptive variable names!!1&#8221; and then typed <code>x = 5</code>. It&#8217;s just the way
things are. And since this book is essentially a collection of advice at that
high level, I can see someone reading this book, and then just simply not
following the advice. I&#8217;m not sure if this is something Josh could have fixed,
or if it&#8217;s inherent in this kind of book. Also, it won&#8217;t affect a diligent
reader. It is something to think about, though.</p>

<h2>Summary: If you just graduated, buy this book</h2>

<p>This book is totally worth it. The style reminds me of the seminal <em>Pragmatic
Programmers</em>. If you&#8217;re a freshly minted graduate, put this book at the top of
your reading list, then also grab a copy of all the books in the bibliography to
read later.</p>
</div>
  
  


  </article>


  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/2011/11/17/burnout.html">Burnout</a></h1>
    
    
      <p class="meta">





  



<time datetime="2011-11-17T09:57:00-05:00" pubdate  data-updated="true" >Nov 17<span>th</span>, 2011</time></p>
    
  </header>


  <div class="entry-content"><p>I have a confession to make: Other than one little stint at RubyC, I
haven&#8217;t really written code in almost a month. And I haven&#8217;t really written a
&#8216;real&#8217; blog post in almost six weeks.</p>

<p>It happens. I was hitting it really hard there for a while, and the
combination of stresses from travel, speaking, writing, conference parties, and
everything else was really getting to me. I don&#8217;t think that I was burned out
<em>yet</em>, but I decided to explicitly take the last two weeks off from doing
almost anything to prevent myself from getting to that point.</p>

<p>This doesn&#8217;t mean that I&#8217;m going to <em>stop</em> doing any of these things. I&#8217;d be
lying if I tried to say that I&#8217;d be reintroducing long-term balance into my
life. That balance never really existed. I&#8217;ve always been one to throw
myself at things 100%. Balance is something I don&#8217;t do particularly well.</p>

<p>One thing I am going to be working on, though, is this: Hackety and Shoes
stress me out. Like a lot. This causes me to avoid working on them, which
makes them not improve so quickly, which makes me stress about it worse. I&#8217;m
not really sure how to fix that one&#8230; but at some point, I&#8217;m going to have to
confront that.</p>

<p>Anyway, hopefully I&#8217;ll be back at it soon. Those of you waiting on some of my
projects, my bad. Things will still be slow for a bit. I&#8217;m going to D.C. this
weekend to teach kids with Hackety and Lego Mindstorms, so maybe that&#8217;ll get
me out of this funk. Or maybe it&#8217;ll delay it another couple of days.</p>

<p>But I&#8217;ll be around again soon.</p>
</div>
  
  


  </article>


  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/2011/10/25/your-startup-is-not-a-platform.html">Your Startup Is NOT a Platform</a></h1>
    
    
      <p class="meta">





  



<time datetime="2011-10-25T13:36:00-04:00" pubdate  data-updated="true" >Oct 25<span>th</span>, 2011</time></p>
    
  </header>


  <div class="entry-content"><p>No, seriously. This is a public service announcment to all MBAs who want to do
startups: &#8216;platform&#8217; does not mean &#8216;web site.&#8217;</p>

<p>I know that &#8216;platform&#8217; is a hot thing right now. But seriously, the term has
become basically useless. It&#8217;s almost to the point that I just pretend you
don&#8217;t even say it.</p>

<p>A platform is primarily a B2B play. It can be B2C too, maybe, but largely, to
have a platform, you need to enable other people to build something.
Usually, that&#8217;s another business. But if your website does not enable
others to build something, or you&#8217;re not white labeling it in some way,
you&#8217;re not a platform.</p>

<p>A platform basically needs an API. APIs are the primary way that two pieces of
software connect to one another. If your web service doesn&#8217;t have an API, it&#8217;s
not a platform. White labeling being an exception.</p>

<p>I&#8217;d make this rant longer, but I really need a good platform that addresses my
market segment. Ideally, it&#8217;ll enable some win-win synergies with other
channel partners and grow the pie for both of us. Until then, I really won&#8217;t find
a good solution for this real pain I feel as a content producer.</p>
</div>
  
  


  </article>


  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/2011/10/19/for-science-im-killing-my-cell-phone.html">For Science: I&#8217;m Killing My Cell Phone</a></h1>
    
    
      <p class="meta">





  



<time datetime="2011-10-19T10:44:00-04:00" pubdate  data-updated="true" >Oct 19<span>th</span>, 2011</time></p>
    
  </header>


  <div class="entry-content"><p>Yep. Doin&#8217; it. This morning I swung by the Sprint store and picked up a 4G
hotspot. Gonna transfer my number to Google Voice this evening.</p>

<h2>lolwhut?</h2>

<p>Yep. I&#8217;m terribly addicted to my phone right now. This is fine, but I&#8217;m
always interested in improving myself. I have a few friends who&#8217;ve done
similar things, and really enjoyed it. So I&#8217;m giving it a solid 6 months.
Sometimes, experiments work, and sometimes they don&#8217;t. I&#8217;m doing this
for fun more than anything, and so it might not work out. Google Maps is
damn handy.</p>

<h2>So I can&#8217;t call you?</h2>

<p>Naw, it just means there might be a tad more latency. I&#8217;m on my computer all
the effing time anyway, so I doubt that you&#8217;ll really notice. If someone
calls when I&#8217;m not at my computer, Google will just take a recording and
email me the transcript. No biggie.</p>

<h2>Yeah, well, have fun with that!</h2>

<p>I will. And I&#8217;ll keep you all posted on how it goes. I plan to do a
retrospective monthly.</p>

<p>EDIT: I had to change my number because Google Voice wouldn&#8217;t transfer my old
one. So get a hold of me some other way, and I&#8217;ll give you the new one.</p>
</div>
  
  


  </article>


  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/2011/10/04/rubinius-is-awesome.html">Rubinius Is Awesome</a></h1>
    
    
      <p class="meta">





  



<time datetime="2011-10-04T08:40:00-04:00" pubdate  data-updated="true" >Oct 4<span>th</span>, 2011</time></p>
    
  </header>


  <div class="entry-content"><p>You walk into work tomorrow morning, and your boss says this:</p>

<blockquote><p>Boss: Hey, we&#8217;re gonna need to go ahead and have you implement
require_relative in rubinius. We have some new servers coming in, and we&#8217;ll
be running it in production, but we use some 1.9.2 features of MRI that
haven&#8217;t been implemented yet. So if you could just go ahead and get to
implementing that, that would be terrific, OK?</p></blockquote>

<p>Wat do?</p>

<p>(Disregard that your boss would never say this. I kinda wish some of mine
would&#8230;)</p>

<blockquote><p>You: Excuse me, I believe you have my stapler&#8230;</p></blockquote>

<p>Err, sorry.</p>

<blockquote><p>You: No problem, boss. Rubinius is mostly just Ruby, and it has a really
helpful core team. I&#8217;m sure it won&#8217;t be a big deal.</p></blockquote>

<p>Would you say this? Well, you should. I&#8217;m not gonna lie and say that <em>every</em>
feature is super simple to implement, or rbx-2.0 would be out already, but for
a language interpreter, Rubinius is one of the easiest I&#8217;ve ever tried to get
into. I actually did implement require_relative last night, and it took me about
an hour and a half.</p>

<p>This is my story.</p>

<p>(note: dramatazation. Actual wording made unneccesarily silly to protect the
innocent. please do try this at home)</p>

<figure role=code><figcaption><span>lol.txt</span></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
<span class='line'>10</span>
<span class='line'>11</span>
<span class='line'>12</span>
</pre></td><td class='code' width='100%'><pre><code class='text'><div class='line'>$ ssh stevessecretserver
</div><div class='line'>$ tmux attach
</div><div class='line'>&lt;brings up irssi, I&#39;m already in #rubinius on Freenode&gt;
</div><div class='line'>#rubinius: steveklabnik: hey, I need require\_relative to run my app. How hard
</div><div class='line'>would you think that is to implement?
</div><div class='line'>#rubinius: evan: Naw, man, it&#39;d take like fifteen minutes. Go check out
</div><div class='line'>http://rubygems.org/gems/rbx-require-relative, it&#39;s alredy basically got what
</div><div class='line'>you want
</div><div class='line'>#rubinius: steveklabnik: sweet.
</div><div class='line'>#rubinius: brixen: just grep for &#39;def require&#39;
</div><div class='line'>#rubinius: brixen: and run bin/mspec -tx19 core/kernel/require\_relative to
</div><div class='line'>run the RubySpecs for it.
</div></code></pre></td></tr></table></div></figure>


<p>Armed with this knowledge, I found where require is defined in rbx:</p>

<figure role=code><figcaption><span>kernel/common/kernel.rb </span><a href='https://github.com/rubinius/rubinius/blob/589f1b08bfece6b86c1332a976704eb792025401/kernel/common/kernel.rb#L737'>link</a></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
</pre></td><td class='code' width='100%'><pre><code class='ruby'><div class='line'><span class="k">def</span> <span class="nf">require</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</div><div class='line'>  <span class="no">Rubinius</span><span class="o">::</span><span class="no">CodeLoader</span><span class="o">.</span><span class="n">require</span> <span class="nb">name</span>
</div><div class='line'><span class="k">end</span>
</div><div class='line'><span class="kp">module_function</span> <span class="ss">:require</span>
</div></code></pre></td></tr></table></div></figure>


<p>Of course, I had to look at CodeLoader:</p>

<figure role=code><figcaption><span>kernel/common/codeloader.rb </span><a href='https://github.com/rubinius/rubinius/blob/589f1b08bfece6b86c1332a976704eb792025401/kernel/common/codeloader.rb#L30'>link</a></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
<span class='line'>10</span>
<span class='line'>11</span>
<span class='line'>12</span>
<span class='line'>13</span>
<span class='line'>14</span>
<span class='line'>15</span>
<span class='line'>16</span>
<span class='line'>17</span>
<span class='line'>18</span>
<span class='line'>19</span>
<span class='line'>20</span>
<span class='line'>21</span>
</pre></td><td class='code' width='100%'><pre><code class='ruby'><div class='line'><span class="c1"># Searches for and loads Ruby source files and shared library extension</span>
</div><div class='line'><span class="c1"># files. See CodeLoader.require for the rest of Kernel#require</span>
</div><div class='line'><span class="c1"># functionality.</span>
</div><div class='line'><span class="k">def</span> <span class="nf">require</span>
</div><div class='line'>  <span class="no">Rubinius</span><span class="o">.</span><span class="n">synchronize</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span> <span class="k">do</span>
</div><div class='line'>    <span class="k">return</span> <span class="kp">false</span> <span class="k">unless</span> <span class="n">resolve_require_path</span>
</div><div class='line'>    <span class="k">return</span> <span class="kp">false</span> <span class="k">if</span> <span class="no">CodeLoader</span><span class="o">.</span><span class="n">loading?</span> <span class="vi">@load_path</span>
</div><div class='line'>
</div><div class='line'>    <span class="k">if</span> <span class="vi">@type</span> <span class="o">==</span> <span class="ss">:ruby</span>
</div><div class='line'>      <span class="no">CodeLoader</span><span class="o">.</span><span class="n">loading</span> <span class="vi">@load_path</span>
</div><div class='line'>    <span class="k">end</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'>
</div><div class='line'>  <span class="k">if</span> <span class="vi">@type</span> <span class="o">==</span> <span class="ss">:ruby</span>
</div><div class='line'>    <span class="n">load_file</span>
</div><div class='line'>  <span class="k">else</span>
</div><div class='line'>    <span class="n">load_library</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'>
</div><div class='line'>  <span class="k">return</span> <span class="vi">@type</span>
</div><div class='line'><span class="k">end</span>
</div></code></pre></td></tr></table></div></figure>


<p>Hmm, see <code>CodeLoader.require</code>. There are codeloader18 and codeloader19
files&#8230;</p>

<figure role=code><figcaption><span>kernel/common/codeloader19.rb </span><a href='https://github.com/rubinius/rubinius/blob/589f1b08bfece6b86c1332a976704eb792025401/kernel/common/codeloader19.rb'>link</a></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
<span class='line'>10</span>
<span class='line'>11</span>
<span class='line'>12</span>
<span class='line'>13</span>
<span class='line'>14</span>
<span class='line'>15</span>
<span class='line'>16</span>
<span class='line'>17</span>
<span class='line'>18</span>
<span class='line'>19</span>
</pre></td><td class='code' width='100%'><pre><code class='ruby'><div class='line'><span class="k">module</span> <span class="nn">Rubinius</span>
</div><div class='line'>  <span class="k">class</span> <span class="nc">CodeLoader</span>
</div><div class='line'>
</div><div class='line'>    <span class="c1"># Searches $LOAD_PATH for a file named +name+. Does not append any file</span>
</div><div class='line'>    <span class="c1"># extension to +name+ while searching. Used by #load to resolve the name</span>
</div><div class='line'>    <span class="c1"># to a full path to load. Also used by #require when the file extension is</span>
</div><div class='line'>    <span class="c1"># provided.</span>
</div><div class='line'>    <span class="k">def</span> <span class="nf">search_load_path</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">loading</span><span class="p">)</span>
</div><div class='line'>      <span class="vg">$LOAD_PATH</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">dir</span><span class="o">|</span>
</div><div class='line'>        <span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">dir</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">&quot;</span>
</div><div class='line'>        <span class="k">return</span> <span class="n">path</span> <span class="k">if</span> <span class="n">loadable?</span> <span class="n">path</span>
</div><div class='line'>      <span class="k">end</span>
</div><div class='line'>
</div><div class='line'>      <span class="k">return</span> <span class="nb">name</span> <span class="k">if</span> <span class="n">loading</span> <span class="ow">and</span> <span class="n">loadable?</span> <span class="s2">&quot;./</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">&quot;</span>
</div><div class='line'>
</div><div class='line'>      <span class="k">return</span> <span class="kp">nil</span>
</div><div class='line'>    <span class="k">end</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'><span class="k">end</span>
</div></code></pre></td></tr></table></div></figure>


<p>Okay. So we define specific stuff into the 19 file. There&#8217;s also a
kernel19. So I worked this up:</p>

<figure role=code><figcaption><span>kernel/common/kernel19.rb</span></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
</pre></td><td class='code' width='100%'><pre><code class='ruby'><div class='line'><span class="c1"># Attempt to load the given file, returning true if successful. Works just</span>
</div><div class='line'><span class="c1"># like Kernel#require, except that it searches relative to the current</span>
</div><div class='line'><span class="c1"># directory.</span>
</div><div class='line'><span class="c1">#</span>
</div><div class='line'><span class="k">def</span> <span class="nf">require_relative</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</div><div class='line'>  <span class="no">Rubinius</span><span class="o">::</span><span class="no">CodeLoader</span><span class="o">.</span><span class="n">require_relative</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</div><div class='line'><span class="k">end</span>
</div><div class='line'><span class="kp">module_function</span> <span class="ss">:require_relative</span>
</div></code></pre></td></tr></table></div></figure>




<figure role=code><figcaption><span>kernel/common/codeloader19.rb</span></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
<span class='line'>10</span>
<span class='line'>11</span>
</pre></td><td class='code' width='100%'><pre><code class='ruby'><div class='line'><span class="c1"># requires files relative to the current directory. We do one interesting</span>
</div><div class='line'><span class="c1"># check to make sure it&#39;s not called inside of an eval.</span>
</div><div class='line'><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">require_relative</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</div><div class='line'>  <span class="n">scope</span> <span class="o">=</span> <span class="no">Rubinius</span><span class="o">::</span><span class="no">StaticScope</span><span class="o">.</span><span class="n">of_sender</span>
</div><div class='line'>  <span class="n">script</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">current_script</span>
</div><div class='line'>  <span class="k">if</span> <span class="n">script</span>
</div><div class='line'>    <span class="nb">require</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">script</span><span class="o">.</span><span class="n">data_path</span><span class="p">),</span> <span class="nb">name</span><span class="p">)</span>
</div><div class='line'>  <span class="k">else</span>
</div><div class='line'>    <span class="k">raise</span> <span class="no">LoadError</span><span class="o">.</span><span class="n">new</span> <span class="s2">&quot;Something is wrong in trying to get relative path&quot;</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'><span class="k">end</span>
</div></code></pre></td></tr></table></div></figure>


<p>But then&#8230; running the specs gives me bunches of errors. What gives?</p>

<figure role=code><figcaption><span>lol.txt</span></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
</pre></td><td class='code' width='100%'><pre><code class='text'><div class='line'>&lt;back in irc&gt;
</div><div class='line'>#rubinius: steveklabnik: yo, my specs are failing, and I&#39;m a n00b. Halp
</div><div class='line'>pl0x?
</div><div class='line'>#rubinius: brixen: oh, yeah, well, the StaticScope is the current scope,
</div><div class='line'>and you&#39;re down another method, so that&#39;s _totally_ gonna screw up
</div><div class='line'>your paths. Just get it above and pass it down. Oh, and File.join is
</div><div class='line'>dumb, File.expand_path that shit!
</div><div class='line'>#rubinius: steveklabnik: words.
</div></code></pre></td></tr></table></div></figure>


<p>So then I made this one little change:</p>

<figure role=code><figcaption><span>kernel/common/kernel19.rb</span></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
</pre></td><td class='code' width='100%'><pre><code class='ruby'><div class='line'><span class="c1"># Attempt to load the given file, returning true if successful. Works just</span>
</div><div class='line'><span class="c1"># like Kernel#require, except that it searches relative to the current</span>
</div><div class='line'><span class="c1"># directory.</span>
</div><div class='line'><span class="c1">#</span>
</div><div class='line'><span class="k">def</span> <span class="nf">require_relative</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</div><div class='line'>  <span class="n">scope</span> <span class="o">=</span> <span class="no">Rubinius</span><span class="o">::</span><span class="no">StaticScope</span><span class="o">.</span><span class="n">of_sender</span>
</div><div class='line'>  <span class="no">Rubinius</span><span class="o">::</span><span class="no">CodeLoader</span><span class="o">.</span><span class="n">require_relative</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span>
</div><div class='line'><span class="k">end</span>
</div><div class='line'><span class="kp">module_function</span> <span class="ss">:require_relative</span>
</div></code></pre></td></tr></table></div></figure>




<figure role=code><figcaption><span>kernel/common/codeloader19.rb</span></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
<span class='line'>10</span>
</pre></td><td class='code' width='100%'><pre><code class='ruby'><div class='line'><span class="c1"># requires files relative to the current directory. We do one interesting</span>
</div><div class='line'><span class="c1"># check to make sure it&#39;s not called inside of an eval.</span>
</div><div class='line'><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">require_relative</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span>
</div><div class='line'>  <span class="n">script</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">current_script</span>
</div><div class='line'>  <span class="k">if</span> <span class="n">script</span>
</div><div class='line'>    <span class="nb">require</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">script</span><span class="o">.</span><span class="n">data_path</span><span class="p">))</span>
</div><div class='line'>  <span class="k">else</span>
</div><div class='line'>    <span class="k">raise</span> <span class="no">LoadError</span><span class="o">.</span><span class="n">new</span> <span class="s2">&quot;Something is wrong in trying to get relative path&quot;</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'><span class="k">end</span>
</div></code></pre></td></tr></table></div></figure>




<figure role=code><figcaption><span></span></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
</pre></td><td class='code' width='100%'><pre><code class='bash'><div class='line'><span class="nv">$ </span>bin/mspec -tx19 core/kernel/require_relative
</div><div class='line'>rubinius 2.0.0dev <span class="o">(</span>1.9.2 cade3517 yyyy-mm-dd JI<span class="o">)</span> <span class="o">[</span>x86_64-apple-darwin10.8.0<span class="o">]</span>
</div><div class='line'>.....................
</div><div class='line'>
</div><div class='line'>Finished in 0.191995 seconds
</div><div class='line'>
</div><div class='line'>1 file, 20 examples, 47 expectations, 0 failures, 0 errors
</div></code></pre></td></tr></table></div></figure>


<p><img src="/images/awwwyeah.jpg" alt="awwww yeah" /></p>

<p>One more pull request, and I&#8217;ve got a patch in on rbx. I had one a few
months ago, but this one was way cooler.</p>

<h2>In conclusion</h2>

<p>Even if I didn&#8217;t have some code to look at, because Rubinius is just Ruby, it
was really easy to dive in and check out the code, because it&#8217;s all Ruby.
Seriously. Rubinius is just Ruby. Just Ruby. Ruby.</p>

<p>So dive in and add some features today! If having an awesome alternate Ruby
implementation isn&#8217;t enough for you, the rbx team will bribe you with
special stickers for committers, and sweet black-on-black tshirts for
people with 10 commits or more!</p>
</div>
  
  


  </article>


  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/2011/10/01/github-is-anarchy-for-programmers.html">GitHub Is Anarchy for Programmers</a></h1>
    
    
      <p class="meta">





  



<time datetime="2011-10-01T13:01:00-04:00" pubdate  data-updated="true" >Oct 1<span>st</span>, 2011</time></p>
    
  </header>


  <div class="entry-content"><p>I finally got to see Zach Holman give his talk, <a href="http://speakerdeck.com/u/holman/p/how-github-uses-github-to-build-github">How GitHub Uses GitHub to Build GitHub</a>.
It was awesome. Zach is a great speaker, and the slides don&#8217;t do it justice. I
highly recommend catching it on video or in person sometime.</p>

<p>Anyway, there&#8217;s something that I found really interesting about GitHub&#8217;s
&#8216;process&#8217;: it&#8217;s basically anarchism, applied to software development.</p>

<p>If you&#8217;re not familliar with anarchism, check out <a href="http://truth-reason-liberty.blogspot.com/p/what-i-believe-in.html">&#8220;What I believe in&#8221;</a>.
It&#8217;s a pretty decent introduction to a complicated topic. Ultimately, anarchism
is fairly simple, but it requires dismantling a <em>lot</em> of beliefs that Americans
in particular hold about society, power, and control. We&#8217;re quite happy in this
country to be slaves to the rich, but that&#8217;s another blog post. ;)</p>

<p>Another excellent post on that blog is <a href="http://truth-reason-liberty.blogspot.com/2010/11/digression-on-what-it-means-to-be.html">&#8220;A Digression On What It Means to Be An Anarchist</a>.
I&#8217;m going to use it as a framework to point out my comparison to GitHub. The
first sentence is stolen from TFA, but the second sentence is my GitHub
comparison.</p>

<h2>What anarchists oppose</h2>

<ul>
<li><p>Hierarchy – anarchists oppose domination of one person or group of people by
another as detrimental to human society. GitHub has built a very flat process,
where &#8220;some days the CEO ships more code than I do.&#8221;</p></li>
<li><p>Authority – all forms of authority must bear a heavy burden of proof in order
to demonstrate their legitimacy and necessity. GitHub has hired people that have
built awesome things, and have shown themselves to be a trusted authority in
whatever kind of software that they build. Nobody needs to question if anyone
is in the position to deploy or review some code.</p></li>
<li><p>The state – centralised rule of a set geographical area (country) or people
(nation) by a government of elites is inherently illegitimate. Okay, this has
nothing to do with GitHub all together. All abstractions are leaky here. :)
The same goes for Capitalism and State Socialism too.</p></li>
<li><p>Nationalism and fascism – these are but the worst forms of the state, gaining
the loyalty of the people with strong, often brutal discipline and by developing
an almost religious, fevered love of the state and the rulers in the form of
patriotism. GitHub actively uses multiple programming languages in production,
and while it came out of the Ruby world, they don&#8217;t really run around pitching
&#8220;Ruby is awesome and the only thing you should ever use.&#8221;</p></li>
<li><p>Discrimination – nobody should be excluded or discriminated against based on
nothing more than their gender, ethnicity, sexuality, background, or beliefs. I
don&#8217;t know everyone at GitHub, but it&#8217;s a pretty diverse crew overall. This is
hard for any tech company, but they&#8217;re doing pretty well on the race/sex thing.</p></li>
</ul>


<h2>What anarchists stand for</h2>

<ul>
<li><p>Liberty – all people should be free to live their life as they see fit,
without rules and laws passed from above that serve no purpose other than
control and domination, as long as they are not infringing the right of anybody
else to the same. See Homan&#8217;s talk. That&#8217;s pretty much how they work.</p></li>
<li><p>Equality – as stated above, nobody should face discrimination because of their
gender, ethnicity, sexuality, background, or beliefs. See above comment about
GitHub&#8217;s varied devs.</p></li>
<li><p>Community – human civilisation evolved, from its primitive roots, through the
priciple of Mutual Aid. GitHub has a lot of elements of mutal aid in their
process, where they mention some people in some pull requests, work together
on features, and generally high five until the code is running in production.</p></li>
<li><p>Solidarity – humanity is divided only between the rulers and the ruled. Other
divisions, those which bring about sexism, racism, heterosexism, and other
bigotries, are promoted by the ruling class in order to divide their subjects
and keep them under control. GitHub holds tons of events, buys everyone lots of
beer, and just generally encourages lots of friendly interactions between
everyone. CodeConf was a great group of diverse people hanging out and having
a good time.</p></li>
</ul>


<h2>How anarchy would work</h2>

<ul>
<li><p>Self-management – groups, such as workforces or local communities, would be
free to operate and govern themselves free of any higher authority. GitHub has
no deadlines, no prioritization meetings, and 100% &#8220;do what you want&#8221; time.</p></li>
<li><p>Free association – all individuals would be free to live where they wanted and
associate with who they chose. Zach mentioned in his talk that different people
work on different parts of the site, and it&#8217;s really based on what people are
interested in and what they&#8217;ve done in the past.</p></li>
<li><p>Voluntary federation – instead of the state, where indivudal communities and
groups of people are bound together by the coercive force of a central
authority, local communities and workers collectives can choose for themselves
which other communities or collectives to associate with. Sort of like the free
association comment, people get together and work on what they want to, and
these groups are organic.</p></li>
<li><p>Direct democracy – unlike in parliamentary democracy, these spokespeople would
be just that, elected not to a position of authority but to voice decisions that
remain in the hands of the people, as in trade union and workers council
structures. Anybody can comment on a pull request, add some commits, put in
their two cents, and be heard.</p></li>
<li><p>Mutual Aid – in participatory communities and workers collectives, Mutual Aid
is a central principle. Easily summed up with the phrase “from each according to
his ability, to each according to his need,” this boils down to voluntary
cooperation, fair distribution of resources, and help and support to those who
need it within a local community. As mentioned before, everybody helps each
other out at GitHub to get things done.</p></li>
<li><p>Free, fair trade – for the sharing of resources between different communities
and individuals who opt out of Mutual Aid, anarchy would see the emergence of a
truly free market. This doesn&#8217;t really fit with software, I think. Same with
&#8216;individual liberty.&#8217;</p></li>
<li><p>Collective defence – this is not to say that anarchist society will contain
“perfect people,” and there will certainly be acts of aggression, oppression,
and violence – albeit on a lesser scale than is commonplace in today’s world.
I&#8217;d liken this to things like &#8220;the site is down.&#8221; Everyone at GitHub cares about
GitHub being up, and so they don&#8217;t need someone who&#8217;s responsible for &#8216;defense,&#8217;
as if shit hits the fan, everyone chips in and takes care of it.</p></li>
<li><p>Justice, not vengeance – courts would be elected for each individual case,
rather than appointed and given unnecessary authority, with the aim to establish
guilt or innocence, negotiate reparations, and organise rehabilitation rather
than to support the oppressive prison systems which only make matters worse by
serving as little more than universities of crime. I&#8217;m not sure this fits well
here.</p></li>
</ul>


<h2>All abstractions are leaky</h2>

<p>Just like when &#8216;lean&#8217; was a concept that applied manufacturing techniques to
software development, I don&#8217;t think that &#8216;anarchism&#8217; is a 100% fit with GitHub&#8217;s
process. I do think that it&#8217;s close enough to hold a lot of value, however,
even to the point that Zach had to write a blog post about <a href="http://zachholman.com/posts/scaling-github-employees/">scaling</a>,
which is something that <em>always</em> gets leveled at people talking about anarchism.
I see GitHub in the same way that I see <a href="http://en.wikipedia.org/wiki/Anarchism_in_Spain">anarchist Catalonia</a> or the <a href="http://en.wikipedia.org/wiki/Free_Territory">Free Territory</a> in the Ukraine.
It&#8217;s a place where ideals are actually working in practice. Let&#8217;s just hope that
the <a href="http://en.wikipedia.org/wiki/Anarchist_Catalonia#Clashes_with_the_Communists">communists don&#8217;t betray them when the fascists show up</a>.</p>

<p>Damn leaky abstractions.</p>
</div>
  
  


  </article>


  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/2011/09/28/real-modern-ruby-development.html">(Real) Modern Ruby Development</a></h1>
    
    
      <p class="meta">





  



<time datetime="2011-09-28T06:31:00-04:00" pubdate  data-updated="true" >Sep 28<span>th</span>, 2011</time></p>
    
  </header>


  <div class="entry-content"><p>I came across a blog post the other day titled <a href="http://ascarter.net/2011/09/25/modern-ruby-development.html">Modern Ruby Development</a>.
While it&#8217;s a perfectly fine blog post (other than the digs at rvm&#8230;) it really
should have been titled something more along the lines of &#8220;My default tooling
to build a Rails application.&#8221; I thought of this yesterday, as I was invited
to show up at <a href="http://www.vertigo.com/">Vertigo</a> and show them how we do things
in the Open Source world. Vertigo builds lots of cool things, but they tend to
be very .NET centric, and it was neat for both of us to see how the other half
lives.</p>

<p>Shortly before my &#8216;presentation,&#8217; we decided that I&#8217;d basicaly just build a
little web app in front of them. Live coding to the max! We decided for maximum
awesome, and since I was in town for the Twilio conference, that I&#8217;d make a
Twilio app that they could text and it&#8217;d text you &#8216;hello world: you said #{msg}&#8221;
back. I thought I&#8217;d share that process with you, too. I ended up throwing away
the code, though, because I committed my account credentials into the git repo
to simplify things, so I&#8217;ll just be describing it to you. Check my other posts
for code stuff. ;)</p>

<p>Oh, and one more thing: lots of this stuff is about getting &#8216;iteration zero&#8217; out
of the way: it&#8217;s setup work that you have to do to set the tone for everything
else. In its own way, it&#8217;s also a tooling overview, I&#8217;ve just focused on the
tools that help the process rather than the language stuff. I&#8217;ve already written
a more &#8216;dev proccess&#8217; style post over at <a href="http://timelessrepo.com/bdd-with-rspec-and-steak">Timeless</a>,
about BDD.</p>

<h2>rvm &#8211;rvmrc &#8211;create 1.9.2@hello_text</h2>

<p>First up: decide what Ruby you&#8217;re using. I talked breifly about MRI, Rubinius,
and JRuby, and some pros and cons for each. I still tend to use MRI for my
production code at the moment, but soon, rbx will become my default.</p>

<p>I use rvm because it does exactly what I want.</p>

<h2>mvim README.md</h2>

<p>I really enjoy <a href="http://tom.preston-werner.com/2010/08/23/readme-driven-development.html">README driven development</a>.
I didn&#8217;t actually demo this due to time constraints, but I generally write at
least a minimal README.md before doing anything else. During Windy City Rails,
Tom shared something that he likes doing: <code>mv README.md SPEC.md</code>. That way,
you can keep your actual README in sync with what the code does right now, but
have the final one that you want to work towards too.</p>

<h2>git push origin</h2>

<p>Now that we have a file, we can push it up to GitHub. A few clicks on the web,
a <code>git add remote</code> and <code>git push -u origin master</code> and we&#8217;re off to the races.</p>

<h2>mvim Gemfile &amp;&amp; bundle</h2>

<p>Next up we talked about Bundler, Gemfiles, and managing gems. I talked about
the ability to run your own private gem server for internal gems, and how
easy it is to build and publish a gem.</p>

<h2>mkdir spec</h2>

<p>I then generally type this. I would be lying to you if I told you that I do TDD
100% of the time. Sometimes, I get lazy. But I try to. And since testing is such
a huge part of Ruby culture, and we have world-class testing tools, this is
where I started.</p>

<p>I wrote specs for a model class called SmsGateway. This class would handle
sending a message to a phone via Twilio. I was able to show off rspec, talk
about DSLs, mocking, and TDD.</p>

<h2>mvim something.rb</h2>

<p>In this case it&#8217;s sms_gateway.rb, but you know what I mean. Write some code,
<code>rspec spec/sms_gateway_spec.rb</code>, repeat. Red, Green, Refactor. Wheee!</p>

<h2>mvim .travis.yml</h2>

<p>I wanted to show Travis off, so in my demo I did this before implementing the
gateway class, but normally I&#8217;d do this after the first spec passes.
Continuous Integration and even Continuous Deployment are awesome. Travis
makes it super easy.</p>

<h2>Sign up for external services</h2>

<p>I went over to Twilio&#8217;s site, registered a new account, and got my credentials.
I used their docs to figure out where to put them, and how to get it all going
inside my gateway class (I just mocked it out before), and talked about how
needing to Google for docs is a weakness of Ruby.</p>

<h2>heroku create &amp;&amp; git push heroku master</h2>

<p>Then I showed them how to get going with Heroku, and how easy it was to start
giving them hundreds of dollars per month when you need to scale. .NET people
are used to paying for everything. ;)</p>

<p>I also showed off one of my latest projects, which is an IRC bot that lets me
deploy rstat.us into production. I have some serious Hubot envy. :D</p>

<h2>&#8230; repeat!</h2>

<p>I&#8217;d be lying if I said it worked the first time, I accidentally made a loop
where the app texted itself. Whoops! But that was cool, and showing off my
debugging process (I&#8217;m a <code>puts/throw params</code> debugger) was fun, as well. After
realizing what I did wrong, we had the app working.</p>

<h2>It&#8217;s not quite perfect</h2>

<p>This dev process isn&#8217;t perfect yet. Nothing ever is. I&#8217;m always trying to
improve upon it, but I&#8217;m pretty happy with how quickly I&#8217;m able to turn out
new projects with a reasonable amount of quality. What&#8217;s your workflow? How
does mine suck? <a href="mailto:steve@steveklabnik.com">Email me</a>, I&#8217;d love to hear
about it.</p>
</div>
  
  


  </article>


  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/2011/09/26/im-deleting-my-facebook-tonight.html">I&#8217;m Deleting My Facebook Tonight.</a></h1>
    
    
      <p class="meta">





  



<time datetime="2011-09-26T08:34:00-04:00" pubdate  data-updated="true" >Sep 26<span>th</span>, 2011</time></p>
    
  </header>


  <div class="entry-content"><p>Well, <a href="http://adrianshort.co.uk/2011/09/25/its-the-end-of-the-web-as-we-know-it/">it&#8217;s the end of the web as we know it</a>.
I&#8217;d already been thinking about this all weekend, and last night, I decided. I
just can&#8217;t deal with Facebook&#8217;s crazy privacy stuff anymore. I mean, I already
basically <a href="http://rstat.us">forked Twitter</a> over their ToS, and Facebook has been
a lot more evil for a lot longer. Frictionless sharing is pretty much the last
straw.</p>

<p>I&#8217;ll be using this as an excuse to keep helping out with the federated web.
There&#8217;s a lot of cool stuff in this area, but it needs help. If you&#8217;re a
developer, consider helping out with the <a href="https://github.com/LockerProject/Locker">Locker Project</a>
or <a href="https://github.com/homesteading">the Homesteading Project</a>. The only way
that we can prevent people from becoming digial sharecroppers is by helping them
to &#8216;own their own land.&#8217;</p>

<p>If we&#8217;re Facebook friends, you can always find out how to reach me at
<a href="http://steveklabnik.com">http://steveklabnik.com</a>. Please be careful, and
consider if Facebook&#8217;s privacy settings are really worth it to you. They may be,
and they may not. I&#8217;m under no illusions that the vast majority of people will
give up Facebook, but I figured I&#8217;d warn you anyways.</p>
</div>
  
  


  </article>


  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/2011/09/23/more-rstat-dot-us-refactoring.html">More rstat.us Refactoring</a></h1>
    
    
      <p class="meta">





  



<time datetime="2011-09-23T17:03:00-04:00" pubdate  data-updated="true" >Sep 23<span>rd</span>, 2011</time></p>
    
  </header>


  <div class="entry-content"><p>Hey everyone! I just wanted to share One More Thing with you about this rstat.us
refactoring.</p>

<p>The main thrust of the last article I posted was to show you a technique for
extracting a class, getting it under some kind of test, and then refactoring it
a bit. Refactoring is always an iterative process, and Ryan Bates from the
always awesome <a href="http://railscasts.com">Railscasts</a> asked me why I made the
Salmon class into a module, especially given my recent <a href="/2011/09/06/the-secret-to-rails-oo-design.html">rant</a>
against modules. The answer was, &#8216;because it&#8217;s simpler, and the first thing
I thought of.&#8217; He shared with me an alternate implementation that I like too,
and I wanted to share with you. Check it:</p>

<figure role=code><figcaption><span>app/models/salmon_notifier.rb</span></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
<span class='line'>10</span>
<span class='line'>11</span>
<span class='line'>12</span>
<span class='line'>13</span>
<span class='line'>14</span>
<span class='line'>15</span>
<span class='line'>16</span>
<span class='line'>17</span>
<span class='line'>18</span>
<span class='line'>19</span>
<span class='line'>20</span>
<span class='line'>21</span>
<span class='line'>22</span>
<span class='line'>23</span>
<span class='line'>24</span>
<span class='line'>25</span>
<span class='line'>26</span>
<span class='line'>27</span>
<span class='line'>28</span>
<span class='line'>29</span>
<span class='line'>30</span>
</pre></td><td class='code' width='100%'><pre><code class='ruby'><div class='line'><span class="k">class</span> <span class="nc">SalmonNotifier</span>
</div><div class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">feed</span><span class="p">)</span>
</div><div class='line'>    <span class="vi">@user</span> <span class="o">=</span> <span class="n">user</span>
</div><div class='line'>    <span class="vi">@feed</span> <span class="o">=</span> <span class="n">feed</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'>
</div><div class='line'>  <span class="k">def</span> <span class="nf">mention</span><span class="p">(</span><span class="n">update</span><span class="p">)</span>
</div><div class='line'>    <span class="n">deliver</span> <span class="no">OStatus</span><span class="o">::</span><span class="no">Salmon</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">to_atom</span><span class="p">(</span><span class="s2">&quot;http://</span><span class="si">#{</span><span class="vi">@user</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">domain</span><span class="si">}</span><span class="s2">/&quot;</span><span class="p">))</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'>
</div><div class='line'>  <span class="k">def</span> <span class="nf">follow</span>
</div><div class='line'>    <span class="n">deliver</span> <span class="no">OStatus</span><span class="o">::</span><span class="no">Salmon</span><span class="o">.</span><span class="n">from_follow</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">to_atom</span><span class="p">,</span> <span class="vi">@feed</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">to_atom</span><span class="p">)</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'>
</div><div class='line'>  <span class="k">def</span> <span class="nf">unfollow</span>
</div><div class='line'>    <span class="n">deliver</span> <span class="no">OStatus</span><span class="o">::</span><span class="no">Salmon</span><span class="o">.</span><span class="n">from_unfollow</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">to_atom</span><span class="p">,</span> <span class="vi">@feed</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">to_atom</span><span class="p">)</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'>
</div><div class='line'>  <span class="kp">protected</span>
</div><div class='line'>
</div><div class='line'>  <span class="k">def</span> <span class="nf">deliver</span><span class="p">(</span><span class="n">salmon</span><span class="p">)</span>
</div><div class='line'>    <span class="n">send_envelope_to_salmon_endpoint</span> <span class="n">salmon</span><span class="o">.</span><span class="n">to_xml</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">to_rsa_keypair</span><span class="p">)</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'>
</div><div class='line'>  <span class="k">def</span> <span class="nf">send_envelope_to_salmon_endpoint</span><span class="p">(</span><span class="n">envelope</span><span class="p">)</span>
</div><div class='line'>    <span class="n">uri</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="vi">@feed</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">salmon_url</span><span class="p">)</span>
</div><div class='line'>    <span class="n">http</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">uri</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
</div><div class='line'>    <span class="n">http</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">envelope</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;application/magic-envelope+xml&quot;</span><span class="p">})</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'><span class="k">end</span>
</div></code></pre></td></tr></table></div></figure>


<p>This follows a more OO style, and is a bit more well-factored. Here&#8217;s his
description of what he did:</p>

<blockquote><p>1. Switched to a class and gave it a name that is a noun (maybe name<br/>should be different though).<br/>2. Moved common method params into instance variables.<br/>3. This simplified the mention/follow/unfollow methods enough to be on one line.<br/>4. Renamed &#8220;send_to_salmon_endpoint&#8221; to &#8220;deliver&#8221; because it feels<br/>nicer, the &#8220;salmon endpoint&#8221; can be assumed due to the name of the<br/>class. I generally don&#8217;t like to put the class name in the method<br/>name.<br/>5. Extracted commented out into its own method with the same name. I<br/>don&#8217;t know if this is really necessary though (same reason as above).</p><p>The only thing that bothers me now is the constant access of<br/>@user.author and @feed.author. This makes me think it should be<br/>interacting directly with authors. However you still need access to<br/>@user.to_rsa_keypair but maybe that method could be moved elsewhere<br/>more accessible.</p></blockquote>


<p>All of these changes are pretty good. Ryan&#8217;s suggestions for moving forward are
pretty good, as well, but I&#8217;d add one more thing: we&#8217;re starting to collect a
bunch of methods all related to delivering more generic HTTP requests in the
protected section. This also might be worth pulling out, too.  Protected/private
in general is a minor smell that indicates there&#8217;s code being used multiple
times that&#8217;s not part of the main objective of the class.  It might not be worth
it yet, but then again, it might. Speaking of protected methods, you might
wonder why I ended up mocking out my protected method in the last post, as well.
There are no more tests that actually test the method is working properly.  This
is true, and it&#8217;s because I was leading into thinking of something like this.
Mocked tests are almost always unit tests, and two methods are two separate
units, so I had just ended up doing it out of habit. This further shows that
maybe an extraction of another class is worthwhile.</p>
</div>
  
  


  </article>


  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/2011/09/22/extracting-domain-models-a-practical-example.html">Extracting Domain Models: A Practical Example</a></h1>
    
    
      <p class="meta">





  



<time datetime="2011-09-22T10:25:00-04:00" pubdate  data-updated="true" >Sep 22<span>nd</span>, 2011</time></p>
    
  </header>


  <div class="entry-content"><p>Hey everyone! We&#8217;ve been doing a lot of refactoring on rstat.us lately, and I
wanted to share with you a refactoring that I did. It&#8217;s a real-world example
of doing the domain models concept that I&#8217;ve been talking about lately.</p>

<h2>Step one: check the tests</h2>

<blockquote><p>I don&#8217;t know how much more emphasized step 1 of refactoring could be: don&#8217;t touch anything that doesn&#8217;t have coverage. Otherwise, you&#8217;re not refactoring; you&#8217;re just changing shit.
- Hamlet D&#8217;Arcy</p></blockquote>

<p>One of the best reasons to extract extra domain models is that they&#8217;re often
much easier to test. They have less dependencies, less code, and are much
simpler than the Mega Models that happen if you have a 1-1 model to table
ratio.</p>

<p>Let&#8217;s check out the code. It&#8217;s in our User model:</p>

<figure role=code><figcaption><span>app/models/user.rb </span><a href='https://github.com/hotsh/rstat.us/blob/362cb38031/app/models/user.rb#L209'>link</a></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
<span class='line'>10</span>
<span class='line'>11</span>
<span class='line'>12</span>
<span class='line'>13</span>
<span class='line'>14</span>
<span class='line'>15</span>
</pre></td><td class='code' width='100%'><pre><code class='ruby'><div class='line'><span class="c1"># Send an update to a remote user as a Salmon notification</span>
</div><div class='line'><span class="k">def</span> <span class="nf">send_mention_notification</span> <span class="n">update_id</span><span class="p">,</span> <span class="n">to_feed_id</span>
</div><div class='line'>  <span class="n">f</span> <span class="o">=</span> <span class="no">Feed</span><span class="o">.</span><span class="n">first</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">to_feed_id</span>
</div><div class='line'>  <span class="n">u</span> <span class="o">=</span> <span class="no">Update</span><span class="o">.</span><span class="n">first</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">update_id</span>
</div><div class='line'>
</div><div class='line'>  <span class="n">base_uri</span> <span class="o">=</span> <span class="s2">&quot;http://</span><span class="si">#{</span><span class="n">author</span><span class="o">.</span><span class="n">domain</span><span class="si">}</span><span class="s2">/&quot;</span>
</div><div class='line'>  <span class="n">salmon</span> <span class="o">=</span> <span class="no">OStatus</span><span class="o">::</span><span class="no">Salmon</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">to_atom</span><span class="p">(</span><span class="n">base_uri</span><span class="p">))</span>
</div><div class='line'>
</div><div class='line'>  <span class="n">envelope</span> <span class="o">=</span> <span class="n">salmon</span><span class="o">.</span><span class="n">to_xml</span> <span class="nb">self</span><span class="o">.</span><span class="n">to_rsa_keypair</span>
</div><div class='line'>
</div><div class='line'>  <span class="c1"># Send envelope to Author&#39;s Salmon endpoint</span>
</div><div class='line'>  <span class="n">uri</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">salmon_url</span><span class="p">)</span>
</div><div class='line'>  <span class="n">http</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">uri</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
</div><div class='line'>  <span class="n">res</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">envelope</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;application/magic-envelope+xml&quot;</span><span class="p">})</span>
</div><div class='line'><span class="k">end</span>
</div></code></pre></td></tr></table></div></figure>


<p>You&#8217;re probably saying &#8220;this is pretty reasonable.&#8221; Prepare to get shocked&#8230;</p>

<p>This code has very little to do with the user, other than using some of the
User&#8217;s attributes. This really could be factored out into a domain object
whose job it is to push Salmon notifications. But first, let&#8217;s see if we can get
some tests in place so we know <em>everything</em> isn&#8217;t broken. Examining this method,
we need two things: an <code>update_id</code> and a <code>feed_id</code>. Here&#8217;s my first stab at an
integration test:</p>

<figure role=code><figcaption><span>test/models/notify_via_salmon_test.rb</span></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
<span class='line'>10</span>
<span class='line'>11</span>
<span class='line'>12</span>
<span class='line'>13</span>
<span class='line'>14</span>
<span class='line'>15</span>
</pre></td><td class='code' width='100%'><pre><code class='ruby'><div class='line'><span class="n">describe</span> <span class="s2">&quot;salmon update&quot;</span> <span class="k">do</span>
</div><div class='line'>  <span class="n">it</span> <span class="s2">&quot;integration regression test&quot;</span> <span class="k">do</span>
</div><div class='line'>    <span class="n">feed</span> <span class="o">=</span> <span class="no">Feed</span><span class="o">.</span><span class="n">create</span>
</div><div class='line'>    <span class="n">update</span> <span class="o">=</span> <span class="no">Update</span><span class="o">.</span><span class="n">create</span>
</div><div class='line'>
</div><div class='line'>    <span class="n">salmon</span> <span class="o">=</span> <span class="n">double</span><span class="p">(</span><span class="ss">:to_xml</span> <span class="o">=&gt;</span> <span class="s2">&quot;&lt;xml&gt;&lt;/xml&gt;&quot;</span><span class="p">)</span>
</div><div class='line'>    <span class="n">uri</span> <span class="o">=</span> <span class="n">double</span><span class="p">(</span><span class="ss">:host</span> <span class="o">=&gt;</span> <span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="ss">:port</span> <span class="o">=&gt;</span> <span class="s2">&quot;9001&quot;</span><span class="p">,</span> <span class="ss">:path</span> <span class="o">=&gt;</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
</div><div class='line'>    <span class="no">Ostatus</span><span class="o">::</span><span class="no">Salmon</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:new</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="n">salmon</span><span class="p">)</span>
</div><div class='line'>    <span class="no">Uri</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:parse</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
</div><div class='line'>    <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:new</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="n">mock</span><span class="p">(</span><span class="ss">:post</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">))</span>
</div><div class='line'>
</div><div class='line'>    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create</span>
</div><div class='line'>    <span class="n">user</span><span class="o">.</span><span class="n">send_mention_notification</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">feed</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'><span class="k">end</span>
</div></code></pre></td></tr></table></div></figure>


<p>This is an integration test, we&#8217;re obviously testing stuff with a ton of models.
After running <code>ruby test/models/notify_via_salmon.rb</code> about a zillion times, I
ended up with this running test:</p>

<figure role=code><figcaption><span>test/models/notify_via_salmon.rb</span></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
<span class='line'>10</span>
<span class='line'>11</span>
<span class='line'>12</span>
<span class='line'>13</span>
<span class='line'>14</span>
<span class='line'>15</span>
<span class='line'>16</span>
<span class='line'>17</span>
<span class='line'>18</span>
<span class='line'>19</span>
<span class='line'>20</span>
<span class='line'>21</span>
<span class='line'>22</span>
<span class='line'>23</span>
<span class='line'>24</span>
<span class='line'>25</span>
<span class='line'>26</span>
<span class='line'>27</span>
<span class='line'>28</span>
<span class='line'>29</span>
<span class='line'>30</span>
<span class='line'>31</span>
<span class='line'>32</span>
<span class='line'>33</span>
<span class='line'>34</span>
<span class='line'>35</span>
<span class='line'>36</span>
<span class='line'>37</span>
<span class='line'>38</span>
<span class='line'>39</span>
<span class='line'>40</span>
</pre></td><td class='code' width='100%'><pre><code class='ruby'><div class='line'><span class="nb">require</span> <span class="s1">&#39;minitest/autorun&#39;</span>
</div><div class='line'><span class="nb">require</span> <span class="s1">&#39;rspec/mocks&#39;</span>
</div><div class='line'>
</div><div class='line'><span class="nb">require</span> <span class="s1">&#39;mongo_mapper&#39;</span>
</div><div class='line'><span class="nb">require</span> <span class="s1">&#39;whatlanguage&#39;</span>
</div><div class='line'><span class="no">MongoMapper</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Connection</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;localhost&quot;</span><span class="p">)</span>
</div><div class='line'><span class="no">MongoMapper</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="s1">&#39;rstatus-test&#39;</span>
</div><div class='line'>
</div><div class='line'><span class="n">require_relative</span> <span class="s1">&#39;../../app/models/feed&#39;</span>
</div><div class='line'><span class="n">require_relative</span> <span class="s1">&#39;../../app/models/update&#39;</span>
</div><div class='line'><span class="n">require_relative</span> <span class="s1">&#39;../../app/models/author&#39;</span>
</div><div class='line'><span class="n">require_relative</span> <span class="s1">&#39;../../app/models/authorization&#39;</span>
</div><div class='line'>
</div><div class='line'><span class="vg">$:</span><span class="o">.</span><span class="n">unshift</span><span class="p">(</span><span class="s2">&quot;lib&quot;</span><span class="p">)</span>
</div><div class='line'><span class="n">require_relative</span> <span class="s1">&#39;../../app/models/user&#39;</span>
</div><div class='line'>
</div><div class='line'><span class="nb">require</span> <span class="s1">&#39;ostatus&#39;</span>
</div><div class='line'>
</div><div class='line'><span class="n">describe</span> <span class="s2">&quot;salmon update&quot;</span> <span class="k">do</span>
</div><div class='line'>  <span class="n">before</span> <span class="ss">:each</span> <span class="k">do</span>
</div><div class='line'>    <span class="no">User</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">each</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:destroy</span><span class="p">)</span>
</div><div class='line'>    <span class="no">RSpec</span><span class="o">::</span><span class="no">Mocks</span><span class="o">::</span><span class="n">setup</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'>
</div><div class='line'>  <span class="n">it</span> <span class="s2">&quot;integration regression test&quot;</span> <span class="k">do</span>
</div><div class='line'>    <span class="n">author</span> <span class="o">=</span> <span class="no">Author</span><span class="o">.</span><span class="n">create</span>
</div><div class='line'>    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">:username</span> <span class="o">=&gt;</span> <span class="s2">&quot;steve&quot;</span><span class="p">,</span> <span class="ss">:author</span> <span class="o">=&gt;</span> <span class="n">author</span><span class="p">)</span>
</div><div class='line'>
</div><div class='line'>    <span class="n">feed</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">feed</span>
</div><div class='line'>    <span class="n">update</span> <span class="o">=</span> <span class="no">Update</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">:feed_id</span> <span class="o">=&gt;</span> <span class="n">feed</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="ss">:author_id</span> <span class="o">=&gt;</span> <span class="n">author</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s2">&quot;hello world&quot;</span><span class="p">)</span>
</div><div class='line'>
</div><div class='line'>    <span class="n">salmon</span> <span class="o">=</span> <span class="n">double</span><span class="p">(</span><span class="ss">:to_xml</span> <span class="o">=&gt;</span> <span class="s2">&quot;&lt;xml&gt;&lt;/xml&gt;&quot;</span><span class="p">)</span>
</div><div class='line'>    <span class="n">uri</span> <span class="o">=</span> <span class="n">double</span><span class="p">(</span><span class="ss">:host</span> <span class="o">=&gt;</span> <span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="ss">:port</span> <span class="o">=&gt;</span> <span class="s2">&quot;9001&quot;</span><span class="p">,</span> <span class="ss">:path</span> <span class="o">=&gt;</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
</div><div class='line'>    <span class="no">OStatus</span><span class="o">::</span><span class="no">Salmon</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:new</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="n">salmon</span><span class="p">)</span>
</div><div class='line'>    <span class="no">URI</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:parse</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
</div><div class='line'>    <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:new</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="n">mock</span><span class="p">(</span><span class="ss">:post</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">))</span>
</div><div class='line'>
</div><div class='line'>    <span class="n">user</span><span class="o">.</span><span class="n">send_mention_notification</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">feed</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'><span class="k">end</span>
</div></code></pre></td></tr></table></div></figure>


<p>Holy. Fuck. Seriously. Let me just quote <a href="http://avdi.org">Avdi Grimm</a>:</p>

<blockquote><p>Mocks, and to some degree RSpec, are like the Hydrogen Peroxide of programming: they fizz up where they encounter subtle technical debt.</p><footer><strong>Avdi Grimm,</strong><cite><a href='http://avdi.org/devblog/2011/04/07/rspec-is-for-the-literate/'>&#8220;Rspec Is for the Literate&#8221;</a></cite></footer></blockquote>


<p>This test class is insane. It runs faster than many people&#8217;s integration tests,
clocking in at about 0.4 seconds. But that&#8217;s still an order of magnitude slower
than I&#8217;d like. A suite with 200 tests would still take over a minute. Also, look
at all this junk that we have to do for setup.</p>

<p>All of this pain and effort doesn&#8217;t mean that testing sucks: it means that our
implementation is terrible. So let&#8217;s use that to guide us. We&#8217;ll try to fix this
code by eliminating all of this junk.</p>

<h2>Step two: simple extraction</h2>

<p>First, let&#8217;s extract this out to a domain model. Here&#8217;s the new code:</p>

<figure role=code><figcaption><span>app/models/user.rb</span></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
</pre></td><td class='code' width='100%'><pre><code class='ruby'><div class='line'><span class="c1"># Send an update to a remote user as a Salmon notification</span>
</div><div class='line'><span class="k">def</span> <span class="nf">send_mention_notification</span> <span class="n">update_id</span><span class="p">,</span> <span class="n">to_feed_id</span>
</div><div class='line'>  <span class="no">NotifyViaSalmon</span><span class="o">.</span><span class="n">mention</span><span class="p">(</span><span class="n">update_id</span><span class="p">,</span> <span class="n">to_feed_id</span><span class="p">)</span>
</div><div class='line'><span class="k">end</span>
</div></code></pre></td></tr></table></div></figure>




<figure role=code><figcaption><span>app/models/notify_via_salmon.rb</span></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
<span class='line'>10</span>
<span class='line'>11</span>
<span class='line'>12</span>
<span class='line'>13</span>
<span class='line'>14</span>
<span class='line'>15</span>
<span class='line'>16</span>
<span class='line'>17</span>
<span class='line'>18</span>
</pre></td><td class='code' width='100%'><pre><code class='ruby'><div class='line'><span class="k">module</span> <span class="nn">NotifyViaSalmon</span>
</div><div class='line'>  <span class="kp">extend</span> <span class="nb">self</span>
</div><div class='line'>
</div><div class='line'>  <span class="k">def</span> <span class="nf">mention</span><span class="p">(</span><span class="n">update_id</span><span class="p">,</span> <span class="n">to_feed_id</span><span class="p">)</span>
</div><div class='line'>    <span class="n">f</span> <span class="o">=</span> <span class="no">Feed</span><span class="o">.</span><span class="n">first</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">to_feed_id</span>
</div><div class='line'>    <span class="n">u</span> <span class="o">=</span> <span class="no">Update</span><span class="o">.</span><span class="n">first</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">update_id</span>
</div><div class='line'>
</div><div class='line'>    <span class="n">base_uri</span> <span class="o">=</span> <span class="s2">&quot;http://</span><span class="si">#{</span><span class="n">author</span><span class="o">.</span><span class="n">domain</span><span class="si">}</span><span class="s2">/&quot;</span>
</div><div class='line'>    <span class="n">salmon</span> <span class="o">=</span> <span class="no">OStatus</span><span class="o">::</span><span class="no">Salmon</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">to_atom</span><span class="p">(</span><span class="n">base_uri</span><span class="p">))</span>
</div><div class='line'>
</div><div class='line'>    <span class="n">envelope</span> <span class="o">=</span> <span class="n">salmon</span><span class="o">.</span><span class="n">to_xml</span> <span class="nb">self</span><span class="o">.</span><span class="n">to_rsa_keypair</span>
</div><div class='line'>
</div><div class='line'>    <span class="c1"># Send envelope to Author&#39;s Salmon endpoint</span>
</div><div class='line'>    <span class="n">uri</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">salmon_url</span><span class="p">)</span>
</div><div class='line'>    <span class="n">http</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">uri</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
</div><div class='line'>    <span class="n">res</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">envelope</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;application/magic-envelope+xml&quot;</span><span class="p">})</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'><span class="k">end</span>
</div></code></pre></td></tr></table></div></figure>


<p>Now, when we run the test (via <code>ruby test/models/notify_via_salmon_test.rb</code>) we
see an error:</p>

<figure role=code><figcaption><span>app/models/notify_via_salmon.rb</span></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
</pre></td><td class='code' width='100%'><pre><code class='ruby'><div class='line'><span class="mi">1</span><span class="p">)</span> <span class="no">Error</span><span class="p">:</span>
</div><div class='line'><span class="n">test_0001_integration_regression_test</span><span class="p">(</span><span class="no">SalmonUpdateSpec</span><span class="p">):</span>
</div><div class='line'><span class="no">NameError</span><span class="p">:</span> <span class="n">undefined</span> <span class="n">local</span> <span class="n">variable</span> <span class="ow">or</span> <span class="nb">method</span> <span class="sb">`author&#39; for NotifyViaSalmon:Module</span>
</div><div class='line'><span class="sb">    /Users/steveklabnik/src/rstat.us/app/models/notify_via_salmon.rb:8:in `</span><span class="n">mention</span><span class="err">&#39;</span>
</div></code></pre></td></tr></table></div></figure>


<p>This is a form of Lean On The Compiler. This test is now failing because it&#8217;s
relying on stuff that used to be internal to the User, and we don&#8217;t have that
stuff now. After doing this a few times, we&#8217;re left with this:</p>

<figure role=code><figcaption><span>app/models/user.rb</span></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
</pre></td><td class='code' width='100%'><pre><code class='ruby'><div class='line'><span class="c1"># Send an update to a remote user as a Salmon notification</span>
</div><div class='line'><span class="k">def</span> <span class="nf">send_mention_notification</span> <span class="n">update_id</span><span class="p">,</span> <span class="n">to_feed_id</span>
</div><div class='line'>  <span class="no">NotifyViaSalmon</span><span class="o">.</span><span class="n">mention</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="n">update_id</span><span class="p">,</span> <span class="n">to_feed_id</span><span class="p">)</span>
</div><div class='line'><span class="k">end</span>
</div></code></pre></td></tr></table></div></figure>




<figure role=code><figcaption><span>app/models/notify_via_salmon.rb</span></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
<span class='line'>10</span>
<span class='line'>11</span>
<span class='line'>12</span>
<span class='line'>13</span>
<span class='line'>14</span>
<span class='line'>15</span>
<span class='line'>16</span>
<span class='line'>17</span>
<span class='line'>18</span>
</pre></td><td class='code' width='100%'><pre><code class='ruby'><div class='line'><span class="k">module</span> <span class="nn">NotifyViaSalmon</span>
</div><div class='line'>  <span class="kp">extend</span> <span class="nb">self</span>
</div><div class='line'>
</div><div class='line'>  <span class="k">def</span> <span class="nf">mention</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">update_id</span><span class="p">,</span> <span class="n">to_feed_id</span><span class="p">)</span>
</div><div class='line'>    <span class="n">f</span> <span class="o">=</span> <span class="no">Feed</span><span class="o">.</span><span class="n">first</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">to_feed_id</span>
</div><div class='line'>    <span class="n">u</span> <span class="o">=</span> <span class="no">Update</span><span class="o">.</span><span class="n">first</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">update_id</span>
</div><div class='line'>
</div><div class='line'>    <span class="n">base_uri</span> <span class="o">=</span> <span class="s2">&quot;http://</span><span class="si">#{</span><span class="n">user</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">domain</span><span class="si">}</span><span class="s2">/&quot;</span>
</div><div class='line'>    <span class="n">salmon</span> <span class="o">=</span> <span class="no">OStatus</span><span class="o">::</span><span class="no">Salmon</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">to_atom</span><span class="p">(</span><span class="n">base_uri</span><span class="p">))</span>
</div><div class='line'>
</div><div class='line'>    <span class="n">envelope</span> <span class="o">=</span> <span class="n">salmon</span><span class="o">.</span><span class="n">to_xml</span> <span class="n">user</span><span class="o">.</span><span class="n">to_rsa_keypair</span>
</div><div class='line'>
</div><div class='line'>    <span class="c1"># Send envelope to Author&#39;s Salmon endpoint</span>
</div><div class='line'>    <span class="n">uri</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">salmon_url</span><span class="p">)</span>
</div><div class='line'>    <span class="n">http</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">uri</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
</div><div class='line'>    <span class="n">res</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">envelope</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;application/magic-envelope+xml&quot;</span><span class="p">})</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'><span class="k">end</span>
</div></code></pre></td></tr></table></div></figure>


<p>Okay. Now we&#8217;re cooking. We have a test that&#8217;s isolated, yet still does what we
thought it did before.</p>

<h2>Step three: break dependencies</h2>

<p>Next step: let&#8217;s break the hard dependency this method has on both Feed and
Update. We can do this by moving the finds up into the User method instead of
keeping them in the mention method:</p>

<figure role=code><figcaption><span>app/models/user.rb</span></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
</pre></td><td class='code' width='100%'><pre><code class='ruby'><div class='line'><span class="c1"># Send an update to a remote user as a Salmon notification</span>
</div><div class='line'><span class="k">def</span> <span class="nf">send_mention_notification</span> <span class="n">update_id</span><span class="p">,</span> <span class="n">to_feed_id</span>
</div><div class='line'>  <span class="n">feed</span> <span class="o">=</span> <span class="no">Feed</span><span class="o">.</span><span class="n">first</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">to_feed_id</span>
</div><div class='line'>  <span class="n">update</span> <span class="o">=</span> <span class="no">Update</span><span class="o">.</span><span class="n">first</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">update_id</span>
</div><div class='line'>
</div><div class='line'>  <span class="no">NotifyViaSalmon</span><span class="o">.</span><span class="n">mention</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="n">update</span><span class="p">,</span> <span class="n">feed</span><span class="p">)</span>
</div><div class='line'><span class="k">end</span>
</div></code></pre></td></tr></table></div></figure>




<figure role=code><figcaption><span>app/models/notify_via_salmon.rb</span></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
<span class='line'>10</span>
<span class='line'>11</span>
<span class='line'>12</span>
<span class='line'>13</span>
<span class='line'>14</span>
<span class='line'>15</span>
</pre></td><td class='code' width='100%'><pre><code class='ruby'><div class='line'><span class="k">module</span> <span class="nn">NotifyViaSalmon</span>
</div><div class='line'>  <span class="kp">extend</span> <span class="nb">self</span>
</div><div class='line'>
</div><div class='line'>  <span class="k">def</span> <span class="nf">mention</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">update</span><span class="p">,</span> <span class="n">feed</span><span class="p">)</span>
</div><div class='line'>    <span class="n">base_uri</span> <span class="o">=</span> <span class="s2">&quot;http://</span><span class="si">#{</span><span class="n">user</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">domain</span><span class="si">}</span><span class="s2">/&quot;</span>
</div><div class='line'>    <span class="n">salmon</span> <span class="o">=</span> <span class="no">OStatus</span><span class="o">::</span><span class="no">Salmon</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">to_atom</span><span class="p">(</span><span class="n">base_uri</span><span class="p">))</span>
</div><div class='line'>
</div><div class='line'>    <span class="n">envelope</span> <span class="o">=</span> <span class="n">salmon</span><span class="o">.</span><span class="n">to_xml</span> <span class="n">user</span><span class="o">.</span><span class="n">to_rsa_keypair</span>
</div><div class='line'>
</div><div class='line'>    <span class="c1"># Send envelope to Author&#39;s Salmon endpoint</span>
</div><div class='line'>    <span class="n">uri</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">feed</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">salmon_url</span><span class="p">)</span>
</div><div class='line'>    <span class="n">http</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">uri</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
</div><div class='line'>    <span class="n">res</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">envelope</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;application/magic-envelope+xml&quot;</span><span class="p">})</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'><span class="k">end</span>
</div></code></pre></td></tr></table></div></figure>


<p>Okay. Tests passing. Sweet. Now we can try testing <em>just</em> the mention method.
Let&#8217;s try it by killing most of that crap that was in our test:</p>

<figure role=code><figcaption><span>test/models/notify_via_salmon_test.rb</span></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
<span class='line'>10</span>
<span class='line'>11</span>
<span class='line'>12</span>
<span class='line'>13</span>
<span class='line'>14</span>
</pre></td><td class='code' width='100%'><pre><code class='ruby'><div class='line'><span class="nb">require</span> <span class="s1">&#39;minitest/autorun&#39;</span>
</div><div class='line'><span class="nb">require</span> <span class="s1">&#39;rspec/mocks&#39;</span>
</div><div class='line'>
</div><div class='line'><span class="n">require_relative</span> <span class="s1">&#39;../../app/models/notify_via_salmon&#39;</span>
</div><div class='line'>
</div><div class='line'><span class="n">describe</span> <span class="s2">&quot;salmon update&quot;</span> <span class="k">do</span>
</div><div class='line'>  <span class="n">before</span> <span class="ss">:each</span> <span class="k">do</span>
</div><div class='line'>    <span class="no">RSpec</span><span class="o">::</span><span class="no">Mocks</span><span class="o">::</span><span class="n">setup</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'>
</div><div class='line'>  <span class="n">it</span> <span class="s2">&quot;integration regression test&quot;</span> <span class="k">do</span>
</div><div class='line'>    <span class="no">NotifyViaSalmon</span><span class="o">.</span><span class="n">mention</span><span class="p">(</span><span class="n">stub</span><span class="p">,</span> <span class="n">stub</span><span class="p">,</span> <span class="n">stub</span><span class="p">)</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'><span class="k">end</span>
</div></code></pre></td></tr></table></div></figure>


<p>Let&#8217;s try running this and seeing what happens:</p>

<figure role=code><figcaption><span>test/models/notify_via_salmon_test.rb</span></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
</pre></td><td class='code' width='100%'><pre><code class='ruby'><div class='line'><span class="err">$</span> <span class="n">ruby</span> <span class="nb">test</span><span class="o">/</span><span class="n">models</span><span class="o">/</span><span class="n">notify_via_salmon_test</span><span class="o">.</span><span class="n">rb</span>
</div><div class='line'><span class="no">Loaded</span> <span class="n">suite</span> <span class="nb">test</span><span class="o">/</span><span class="n">models</span><span class="o">/</span><span class="n">notify_via_salmon_test</span>
</div><div class='line'><span class="no">Started</span>
</div><div class='line'><span class="n">E</span>
</div><div class='line'><span class="no">Finished</span> <span class="k">in</span> <span class="mi">0</span><span class="o">.</span><span class="mo">000</span><span class="mi">992</span> <span class="n">seconds</span><span class="o">.</span>
</div><div class='line'>
</div><div class='line'>  <span class="mi">1</span><span class="p">)</span> <span class="no">Error</span><span class="p">:</span>
</div><div class='line'><span class="n">test_0001_integration_regression_test</span><span class="p">(</span><span class="no">SalmonUpdateSpec</span><span class="p">):</span>
</div><div class='line'><span class="no">RSpec</span><span class="o">::</span><span class="no">Mocks</span><span class="o">::</span><span class="no">MockExpectationError</span><span class="p">:</span> <span class="no">Stub</span> <span class="n">received</span> <span class="n">unexpected</span> <span class="n">message</span> <span class="ss">:author</span> <span class="n">with</span> <span class="p">(</span><span class="n">no</span> <span class="n">args</span><span class="p">)</span>
</div></code></pre></td></tr></table></div></figure>


<p>First of all, daaaaamn. 0.001 seconds. Nice. Secondly, okay, we are getting some
messages sent to our stubs. Let&#8217;s flesh them out to make things pass:</p>

<figure role=code><figcaption><span>test/models/notify_via_salmon_test.rb</span></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
<span class='line'>10</span>
<span class='line'>11</span>
<span class='line'>12</span>
<span class='line'>13</span>
<span class='line'>14</span>
<span class='line'>15</span>
<span class='line'>16</span>
<span class='line'>17</span>
<span class='line'>18</span>
<span class='line'>19</span>
<span class='line'>20</span>
<span class='line'>21</span>
<span class='line'>22</span>
<span class='line'>23</span>
<span class='line'>24</span>
<span class='line'>25</span>
<span class='line'>26</span>
</pre></td><td class='code' width='100%'><pre><code class='ruby'><div class='line'><span class="nb">require</span> <span class="s1">&#39;minitest/autorun&#39;</span>
</div><div class='line'><span class="nb">require</span> <span class="s1">&#39;rspec/mocks&#39;</span>
</div><div class='line'><span class="nb">require</span> <span class="s1">&#39;ostatus&#39;</span>
</div><div class='line'>
</div><div class='line'><span class="n">require_relative</span> <span class="s1">&#39;../../app/models/notify_via_salmon&#39;</span>
</div><div class='line'>
</div><div class='line'><span class="n">describe</span> <span class="s2">&quot;salmon update&quot;</span> <span class="k">do</span>
</div><div class='line'>  <span class="n">before</span> <span class="ss">:each</span> <span class="k">do</span>
</div><div class='line'>    <span class="no">RSpec</span><span class="o">::</span><span class="no">Mocks</span><span class="o">::</span><span class="n">setup</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'>
</div><div class='line'>  <span class="n">it</span> <span class="s2">&quot;integration regression test&quot;</span> <span class="k">do</span>
</div><div class='line'>    <span class="n">user</span> <span class="o">=</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:author</span> <span class="o">=&gt;</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:domain</span> <span class="o">=&gt;</span> <span class="s2">&quot;foo&quot;</span><span class="p">),</span> <span class="ss">:to_rsa_keypair</span> <span class="o">=&gt;</span> <span class="n">stub</span><span class="p">)</span>
</div><div class='line'>    <span class="n">update</span> <span class="o">=</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:to_atom</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</div><div class='line'>    <span class="n">feed</span> <span class="o">=</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:author</span> <span class="o">=&gt;</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:salmon_url</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
</div><div class='line'>
</div><div class='line'>    <span class="n">salmon</span> <span class="o">=</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:to_xml</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</div><div class='line'>    <span class="no">OStatus</span><span class="o">::</span><span class="no">Salmon</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:new</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="n">salmon</span><span class="p">)</span>
</div><div class='line'>
</div><div class='line'>    <span class="n">uri</span> <span class="o">=</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:host</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="ss">:port</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="ss">:path</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</div><div class='line'>    <span class="no">URI</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:parse</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
</div><div class='line'>    <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:new</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="n">stub</span><span class="p">(</span><span class="ss">:post</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
</div><div class='line'>
</div><div class='line'>    <span class="no">NotifyViaSalmon</span><span class="o">.</span><span class="n">mention</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">update</span><span class="p">,</span> <span class="n">feed</span><span class="p">)</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'><span class="k">end</span>
</div></code></pre></td></tr></table></div></figure>


<p>Okay! Note how similar this looks to the previous test. We&#8217;re still mocking a
bunch of &#8216;external&#8217; stuff. But other than that, our test is pretty simple: we
make three stubs, and we call our mention method.</p>

<h3>Step four: repeat</h3>

<p>We could do some more work on this method. There are a few things that are
a bit smelly: the nested stub of User is not great. The fact that we&#8217;re stubbing
out three external dependencies isn&#8217;t great. But before we get to that, let&#8217;s
check out another method that looks similar:
<code>send_{follow,unfollow}_notification</code>. Here&#8217;s some code:</p>

<figure role=code><figcaption><span>app/models/user.rb </span><a href='https://github.com/hotsh/rstat.us/blob/362cb38031/app/models/user.rb#L167'>link</a></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
<span class='line'>10</span>
<span class='line'>11</span>
<span class='line'>12</span>
<span class='line'>13</span>
<span class='line'>14</span>
<span class='line'>15</span>
<span class='line'>16</span>
<span class='line'>17</span>
<span class='line'>18</span>
<span class='line'>19</span>
<span class='line'>20</span>
<span class='line'>21</span>
<span class='line'>22</span>
<span class='line'>23</span>
<span class='line'>24</span>
<span class='line'>25</span>
<span class='line'>26</span>
<span class='line'>27</span>
<span class='line'>28</span>
<span class='line'>29</span>
</pre></td><td class='code' width='100%'><pre><code class='ruby'><div class='line'><span class="c1"># Send Salmon notification so that the remote user</span>
</div><div class='line'><span class="c1"># knows this user is following them</span>
</div><div class='line'><span class="k">def</span> <span class="nf">send_follow_notification</span> <span class="n">to_feed_id</span>
</div><div class='line'>  <span class="n">f</span> <span class="o">=</span> <span class="no">Feed</span><span class="o">.</span><span class="n">first</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">to_feed_id</span>
</div><div class='line'>
</div><div class='line'>  <span class="n">salmon</span> <span class="o">=</span> <span class="no">OStatus</span><span class="o">::</span><span class="no">Salmon</span><span class="o">.</span><span class="n">from_follow</span><span class="p">(</span><span class="n">author</span><span class="o">.</span><span class="n">to_atom</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">to_atom</span><span class="p">)</span>
</div><div class='line'>
</div><div class='line'>  <span class="n">envelope</span> <span class="o">=</span> <span class="n">salmon</span><span class="o">.</span><span class="n">to_xml</span> <span class="nb">self</span><span class="o">.</span><span class="n">to_rsa_keypair</span>
</div><div class='line'>
</div><div class='line'>  <span class="c1"># Send envelope to Author&#39;s Salmon endpoint</span>
</div><div class='line'>  <span class="n">uri</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">salmon_url</span><span class="p">)</span>
</div><div class='line'>  <span class="n">http</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">uri</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
</div><div class='line'>  <span class="n">res</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">envelope</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;application/magic-envelope+xml&quot;</span><span class="p">})</span>
</div><div class='line'><span class="k">end</span>
</div><div class='line'>
</div><div class='line'><span class="c1"># Send Salmon notification so that the remote user</span>
</div><div class='line'><span class="c1"># knows this user has stopped following them</span>
</div><div class='line'><span class="k">def</span> <span class="nf">send_unfollow_notification</span> <span class="n">to_feed_id</span>
</div><div class='line'>  <span class="n">f</span> <span class="o">=</span> <span class="no">Feed</span><span class="o">.</span><span class="n">first</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">to_feed_id</span>
</div><div class='line'>
</div><div class='line'>  <span class="n">salmon</span> <span class="o">=</span> <span class="no">OStatus</span><span class="o">::</span><span class="no">Salmon</span><span class="o">.</span><span class="n">from_unfollow</span><span class="p">(</span><span class="n">author</span><span class="o">.</span><span class="n">to_atom</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">to_atom</span><span class="p">)</span>
</div><div class='line'>
</div><div class='line'>  <span class="n">envelope</span> <span class="o">=</span> <span class="n">salmon</span><span class="o">.</span><span class="n">to_xml</span> <span class="nb">self</span><span class="o">.</span><span class="n">to_rsa_keypair</span>
</div><div class='line'>
</div><div class='line'>  <span class="c1"># Send envelope to Author&#39;s Salmon endpoint</span>
</div><div class='line'>  <span class="n">uri</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">salmon_url</span><span class="p">)</span>
</div><div class='line'>  <span class="n">http</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">uri</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
</div><div class='line'>  <span class="n">res</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">envelope</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;application/magic-envelope+xml&quot;</span><span class="p">})</span>
</div><div class='line'><span class="k">end</span>
</div></code></pre></td></tr></table></div></figure>


<p>Look familliar? Yep! 90% the same code! We&#8217;ll do the same process to these
methods, just like the other one. Check out this code and test:</p>

<figure role=code><figcaption><span>app/models/user.rb</span></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
<span class='line'>10</span>
<span class='line'>11</span>
<span class='line'>12</span>
<span class='line'>13</span>
<span class='line'>14</span>
<span class='line'>15</span>
<span class='line'>16</span>
<span class='line'>17</span>
<span class='line'>18</span>
<span class='line'>19</span>
<span class='line'>20</span>
<span class='line'>21</span>
<span class='line'>22</span>
<span class='line'>23</span>
</pre></td><td class='code' width='100%'><pre><code class='ruby'><div class='line'><span class="c1"># Send Salmon notification so that the remote user</span>
</div><div class='line'><span class="c1"># knows this user is following them</span>
</div><div class='line'><span class="k">def</span> <span class="nf">send_follow_notification</span> <span class="n">to_feed_id</span>
</div><div class='line'>  <span class="n">feed</span> <span class="o">=</span> <span class="no">Feed</span><span class="o">.</span><span class="n">first</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">to_feed_id</span>
</div><div class='line'>
</div><div class='line'>  <span class="no">NotifyViaSalmon</span><span class="o">.</span><span class="n">follow</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="n">feed</span><span class="p">)</span>
</div><div class='line'><span class="k">end</span>
</div><div class='line'>
</div><div class='line'><span class="c1"># Send Salmon notification so that the remote user</span>
</div><div class='line'><span class="c1"># knows this user has stopped following them</span>
</div><div class='line'><span class="k">def</span> <span class="nf">send_unfollow_notification</span> <span class="n">to_feed_id</span>
</div><div class='line'>  <span class="n">feed</span> <span class="o">=</span> <span class="no">Feed</span><span class="o">.</span><span class="n">first</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">to_feed_id</span>
</div><div class='line'>
</div><div class='line'>  <span class="no">NotifyViaSalmon</span><span class="o">.</span><span class="n">unfollow</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="n">feed</span><span class="p">)</span>
</div><div class='line'><span class="k">end</span>
</div><div class='line'>
</div><div class='line'><span class="c1"># Send an update to a remote user as a Salmon notification</span>
</div><div class='line'><span class="k">def</span> <span class="nf">send_mention_notification</span> <span class="n">update_id</span><span class="p">,</span> <span class="n">to_feed_id</span>
</div><div class='line'>  <span class="n">feed</span> <span class="o">=</span> <span class="no">Feed</span><span class="o">.</span><span class="n">first</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">to_feed_id</span>
</div><div class='line'>  <span class="n">update</span> <span class="o">=</span> <span class="no">Update</span><span class="o">.</span><span class="n">first</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">update_id</span>
</div><div class='line'>
</div><div class='line'>  <span class="no">NotifyViaSalmon</span><span class="o">.</span><span class="n">mention</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="n">update</span><span class="p">,</span> <span class="n">feed</span><span class="p">)</span>
</div><div class='line'><span class="k">end</span>
</div></code></pre></td></tr></table></div></figure>




<figure role=code><figcaption><span>app/models/notify_via_salmon.rb</span></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
<span class='line'>10</span>
<span class='line'>11</span>
<span class='line'>12</span>
<span class='line'>13</span>
<span class='line'>14</span>
<span class='line'>15</span>
<span class='line'>16</span>
<span class='line'>17</span>
<span class='line'>18</span>
<span class='line'>19</span>
<span class='line'>20</span>
<span class='line'>21</span>
<span class='line'>22</span>
<span class='line'>23</span>
<span class='line'>24</span>
<span class='line'>25</span>
<span class='line'>26</span>
<span class='line'>27</span>
<span class='line'>28</span>
<span class='line'>29</span>
<span class='line'>30</span>
<span class='line'>31</span>
<span class='line'>32</span>
<span class='line'>33</span>
<span class='line'>34</span>
<span class='line'>35</span>
<span class='line'>36</span>
<span class='line'>37</span>
</pre></td><td class='code' width='100%'><pre><code class='ruby'><div class='line'><span class="k">module</span> <span class="nn">NotifyViaSalmon</span>
</div><div class='line'>  <span class="kp">extend</span> <span class="nb">self</span>
</div><div class='line'>
</div><div class='line'>  <span class="k">def</span> <span class="nf">mention</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">update</span><span class="p">,</span> <span class="n">feed</span><span class="p">)</span>
</div><div class='line'>    <span class="n">base_uri</span> <span class="o">=</span> <span class="s2">&quot;http://</span><span class="si">#{</span><span class="n">user</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">domain</span><span class="si">}</span><span class="s2">/&quot;</span>
</div><div class='line'>    <span class="n">salmon</span> <span class="o">=</span> <span class="no">OStatus</span><span class="o">::</span><span class="no">Salmon</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">to_atom</span><span class="p">(</span><span class="n">base_uri</span><span class="p">))</span>
</div><div class='line'>
</div><div class='line'>    <span class="n">envelope</span> <span class="o">=</span> <span class="n">salmon</span><span class="o">.</span><span class="n">to_xml</span> <span class="n">user</span><span class="o">.</span><span class="n">to_rsa_keypair</span>
</div><div class='line'>
</div><div class='line'>    <span class="c1"># Send envelope to Author&#39;s Salmon endpoint</span>
</div><div class='line'>    <span class="n">uri</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">feed</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">salmon_url</span><span class="p">)</span>
</div><div class='line'>    <span class="n">http</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">uri</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
</div><div class='line'>    <span class="n">res</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">envelope</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;application/magic-envelope+xml&quot;</span><span class="p">})</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'>
</div><div class='line'>  <span class="k">def</span> <span class="nf">follow</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">feed</span><span class="p">)</span>
</div><div class='line'>    <span class="n">salmon</span> <span class="o">=</span> <span class="no">OStatus</span><span class="o">::</span><span class="no">Salmon</span><span class="o">.</span><span class="n">from_follow</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">to_atom</span><span class="p">,</span> <span class="n">feed</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">to_atom</span><span class="p">)</span>
</div><div class='line'>
</div><div class='line'>    <span class="n">envelope</span> <span class="o">=</span> <span class="n">salmon</span><span class="o">.</span><span class="n">to_xml</span> <span class="n">user</span><span class="o">.</span><span class="n">to_rsa_keypair</span>
</div><div class='line'>
</div><div class='line'>    <span class="c1"># Send envelope to Author&#39;s Salmon endpoint</span>
</div><div class='line'>    <span class="n">uri</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">feed</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">salmon_url</span><span class="p">)</span>
</div><div class='line'>    <span class="n">http</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">uri</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
</div><div class='line'>    <span class="n">res</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">envelope</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;application/magic-envelope+xml&quot;</span><span class="p">})</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'>
</div><div class='line'>  <span class="k">def</span> <span class="nf">unfollow</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">feed</span><span class="p">)</span>
</div><div class='line'>    <span class="n">salmon</span> <span class="o">=</span> <span class="no">OStatus</span><span class="o">::</span><span class="no">Salmon</span><span class="o">.</span><span class="n">from_unfollow</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">to_atom</span><span class="p">,</span> <span class="n">feed</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">to_atom</span><span class="p">)</span>
</div><div class='line'>
</div><div class='line'>    <span class="n">envelope</span> <span class="o">=</span> <span class="n">salmon</span><span class="o">.</span><span class="n">to_xml</span> <span class="n">user</span><span class="o">.</span><span class="n">to_rsa_keypair</span>
</div><div class='line'>
</div><div class='line'>    <span class="c1"># Send envelope to Author&#39;s Salmon endpoint</span>
</div><div class='line'>    <span class="n">uri</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">feed</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">salmon_url</span><span class="p">)</span>
</div><div class='line'>    <span class="n">http</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">uri</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
</div><div class='line'>    <span class="n">res</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">envelope</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;application/magic-envelope+xml&quot;</span><span class="p">})</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'><span class="k">end</span>
</div></code></pre></td></tr></table></div></figure>




<figure role=code><figcaption><span>test/models/notify_via_salmon_test.rb</span></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
<span class='line'>10</span>
<span class='line'>11</span>
<span class='line'>12</span>
<span class='line'>13</span>
<span class='line'>14</span>
<span class='line'>15</span>
<span class='line'>16</span>
<span class='line'>17</span>
<span class='line'>18</span>
<span class='line'>19</span>
<span class='line'>20</span>
<span class='line'>21</span>
<span class='line'>22</span>
<span class='line'>23</span>
<span class='line'>24</span>
<span class='line'>25</span>
<span class='line'>26</span>
<span class='line'>27</span>
<span class='line'>28</span>
<span class='line'>29</span>
<span class='line'>30</span>
<span class='line'>31</span>
<span class='line'>32</span>
<span class='line'>33</span>
<span class='line'>34</span>
<span class='line'>35</span>
<span class='line'>36</span>
<span class='line'>37</span>
<span class='line'>38</span>
<span class='line'>39</span>
<span class='line'>40</span>
<span class='line'>41</span>
<span class='line'>42</span>
<span class='line'>43</span>
<span class='line'>44</span>
<span class='line'>45</span>
<span class='line'>46</span>
<span class='line'>47</span>
<span class='line'>48</span>
<span class='line'>49</span>
<span class='line'>50</span>
<span class='line'>51</span>
<span class='line'>52</span>
<span class='line'>53</span>
<span class='line'>54</span>
</pre></td><td class='code' width='100%'><pre><code class='ruby'><div class='line'><span class="nb">require</span> <span class="s1">&#39;minitest/autorun&#39;</span>
</div><div class='line'><span class="nb">require</span> <span class="s1">&#39;rspec/mocks&#39;</span>
</div><div class='line'><span class="nb">require</span> <span class="s1">&#39;ostatus&#39;</span>
</div><div class='line'>
</div><div class='line'><span class="n">require_relative</span> <span class="s1">&#39;../../app/models/notify_via_salmon&#39;</span>
</div><div class='line'>
</div><div class='line'><span class="n">describe</span> <span class="no">NotifyViaSalmon</span> <span class="k">do</span>
</div><div class='line'>  <span class="n">before</span> <span class="ss">:each</span> <span class="k">do</span>
</div><div class='line'>    <span class="no">RSpec</span><span class="o">::</span><span class="no">Mocks</span><span class="o">::</span><span class="n">setup</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'>
</div><div class='line'>  <span class="n">it</span> <span class="s2">&quot;.mention&quot;</span> <span class="k">do</span>
</div><div class='line'>    <span class="n">user</span> <span class="o">=</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:author</span> <span class="o">=&gt;</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:domain</span> <span class="o">=&gt;</span> <span class="s2">&quot;foo&quot;</span><span class="p">),</span> <span class="ss">:to_rsa_keypair</span> <span class="o">=&gt;</span> <span class="n">stub</span><span class="p">)</span>
</div><div class='line'>    <span class="n">update</span> <span class="o">=</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:to_atom</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</div><div class='line'>    <span class="n">feed</span> <span class="o">=</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:author</span> <span class="o">=&gt;</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:salmon_url</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
</div><div class='line'>
</div><div class='line'>    <span class="n">salmon</span> <span class="o">=</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:to_xml</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</div><div class='line'>    <span class="no">OStatus</span><span class="o">::</span><span class="no">Salmon</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:new</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="n">salmon</span><span class="p">)</span>
</div><div class='line'>
</div><div class='line'>    <span class="n">uri</span> <span class="o">=</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:host</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="ss">:port</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="ss">:path</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</div><div class='line'>    <span class="no">URI</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:parse</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
</div><div class='line'>    <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:new</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="n">stub</span><span class="p">(</span><span class="ss">:post</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
</div><div class='line'>
</div><div class='line'>    <span class="no">NotifyViaSalmon</span><span class="o">.</span><span class="n">mention</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">update</span><span class="p">,</span> <span class="n">feed</span><span class="p">)</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'>
</div><div class='line'>  <span class="n">it</span> <span class="s2">&quot;.follow&quot;</span> <span class="k">do</span>
</div><div class='line'>    <span class="n">user</span> <span class="o">=</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:author</span> <span class="o">=&gt;</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:domain</span> <span class="o">=&gt;</span> <span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="ss">:to_atom</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">),</span> <span class="ss">:to_rsa_keypair</span> <span class="o">=&gt;</span> <span class="n">stub</span><span class="p">)</span>
</div><div class='line'>    <span class="n">feed</span> <span class="o">=</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:author</span> <span class="o">=&gt;</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:salmon_url</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="ss">:to_atom</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
</div><div class='line'>
</div><div class='line'>    <span class="n">salmon</span> <span class="o">=</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:to_xml</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</div><div class='line'>    <span class="no">OStatus</span><span class="o">::</span><span class="no">Salmon</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:from_follow</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="n">salmon</span><span class="p">)</span>
</div><div class='line'>
</div><div class='line'>    <span class="n">uri</span> <span class="o">=</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:host</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="ss">:port</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="ss">:path</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</div><div class='line'>    <span class="no">URI</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:parse</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
</div><div class='line'>    <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:new</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="n">stub</span><span class="p">(</span><span class="ss">:post</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
</div><div class='line'>
</div><div class='line'>    <span class="no">NotifyViaSalmon</span><span class="o">.</span><span class="n">follow</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">feed</span><span class="p">)</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'>
</div><div class='line'>  <span class="n">it</span> <span class="s2">&quot;.unfollow&quot;</span> <span class="k">do</span>
</div><div class='line'>    <span class="n">user</span> <span class="o">=</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:author</span> <span class="o">=&gt;</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:domain</span> <span class="o">=&gt;</span> <span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="ss">:to_atom</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">),</span> <span class="ss">:to_rsa_keypair</span> <span class="o">=&gt;</span> <span class="n">stub</span><span class="p">)</span>
</div><div class='line'>    <span class="n">feed</span> <span class="o">=</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:author</span> <span class="o">=&gt;</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:salmon_url</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="ss">:to_atom</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
</div><div class='line'>
</div><div class='line'>    <span class="n">salmon</span> <span class="o">=</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:to_xml</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</div><div class='line'>    <span class="no">OStatus</span><span class="o">::</span><span class="no">Salmon</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:from_unfollow</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="n">salmon</span><span class="p">)</span>
</div><div class='line'>
</div><div class='line'>    <span class="n">uri</span> <span class="o">=</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:host</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="ss">:port</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="ss">:path</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</div><div class='line'>    <span class="no">URI</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:parse</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
</div><div class='line'>    <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:new</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="n">stub</span><span class="p">(</span><span class="ss">:post</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
</div><div class='line'>
</div><div class='line'>    <span class="no">NotifyViaSalmon</span><span class="o">.</span><span class="n">unfollow</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">feed</span><span class="p">)</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'><span class="k">end</span>
</div></code></pre></td></tr></table></div></figure>


<p>Now we can see some of these patterns start to emerge, eh? All of this stuff is
starting to come together. Let&#8217;s get rid of the URI and Net::HTTP stuff, as it&#8217;s
just straight up identical in all three. Pretty basic Extract Method:</p>

<figure role=code><figcaption><span>app/models/notify_via_salmon.rb</span></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
<span class='line'>10</span>
<span class='line'>11</span>
<span class='line'>12</span>
<span class='line'>13</span>
<span class='line'>14</span>
<span class='line'>15</span>
<span class='line'>16</span>
<span class='line'>17</span>
<span class='line'>18</span>
<span class='line'>19</span>
<span class='line'>20</span>
<span class='line'>21</span>
<span class='line'>22</span>
<span class='line'>23</span>
<span class='line'>24</span>
<span class='line'>25</span>
<span class='line'>26</span>
<span class='line'>27</span>
<span class='line'>28</span>
<span class='line'>29</span>
<span class='line'>30</span>
<span class='line'>31</span>
<span class='line'>32</span>
<span class='line'>33</span>
</pre></td><td class='code' width='100%'><pre><code class='ruby'><div class='line'><span class="k">module</span> <span class="nn">NotifyViaSalmon</span>
</div><div class='line'>  <span class="kp">extend</span> <span class="nb">self</span>
</div><div class='line'>
</div><div class='line'>  <span class="k">def</span> <span class="nf">mention</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">update</span><span class="p">,</span> <span class="n">feed</span><span class="p">)</span>
</div><div class='line'>    <span class="n">base_uri</span> <span class="o">=</span> <span class="s2">&quot;http://</span><span class="si">#{</span><span class="n">user</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">domain</span><span class="si">}</span><span class="s2">/&quot;</span>
</div><div class='line'>    <span class="n">salmon</span> <span class="o">=</span> <span class="no">OStatus</span><span class="o">::</span><span class="no">Salmon</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">to_atom</span><span class="p">(</span><span class="n">base_uri</span><span class="p">))</span>
</div><div class='line'>
</div><div class='line'>    <span class="n">send_to_salmon_endpoint</span><span class="p">(</span><span class="n">salmon</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">to_rsa_keypair</span><span class="p">,</span> <span class="n">feed</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">salmon_url</span><span class="p">)</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'>
</div><div class='line'>  <span class="k">def</span> <span class="nf">follow</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">feed</span><span class="p">)</span>
</div><div class='line'>    <span class="n">salmon</span> <span class="o">=</span> <span class="no">OStatus</span><span class="o">::</span><span class="no">Salmon</span><span class="o">.</span><span class="n">from_follow</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">to_atom</span><span class="p">,</span> <span class="n">feed</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">to_atom</span><span class="p">)</span>
</div><div class='line'>
</div><div class='line'>    <span class="n">send_to_salmon_endpoint</span><span class="p">(</span><span class="n">salmon</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">to_rsa_keypair</span><span class="p">,</span> <span class="n">feed</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">salmon_url</span><span class="p">)</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'>
</div><div class='line'>  <span class="k">def</span> <span class="nf">unfollow</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">feed</span><span class="p">)</span>
</div><div class='line'>    <span class="n">salmon</span> <span class="o">=</span> <span class="no">OStatus</span><span class="o">::</span><span class="no">Salmon</span><span class="o">.</span><span class="n">from_unfollow</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">to_atom</span><span class="p">,</span> <span class="n">feed</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">to_atom</span><span class="p">)</span>
</div><div class='line'>
</div><div class='line'>    <span class="n">send_to_salmon_endpoint</span><span class="p">(</span><span class="n">salmon</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">to_rsa_keypair</span><span class="p">,</span> <span class="n">feed</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">salmon_url</span><span class="p">)</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'>
</div><div class='line'>  <span class="kp">protected</span>
</div><div class='line'>
</div><div class='line'>  <span class="k">def</span> <span class="nf">send_to_salmon_endpoint</span><span class="p">(</span><span class="n">salmon</span><span class="p">,</span> <span class="n">keypair</span><span class="p">,</span> <span class="n">uri</span><span class="p">)</span>
</div><div class='line'>    <span class="n">envelope</span> <span class="o">=</span> <span class="n">salmon</span><span class="o">.</span><span class="n">to_xml</span> <span class="n">keypair</span>
</div><div class='line'>
</div><div class='line'>    <span class="c1"># Send envelope to Author&#39;s Salmon endpoint</span>
</div><div class='line'>    <span class="n">uri</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
</div><div class='line'>    <span class="n">http</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">uri</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
</div><div class='line'>    <span class="n">res</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">uri</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">envelope</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;application/magic-envelope+xml&quot;</span><span class="p">})</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'><span class="k">end</span>
</div></code></pre></td></tr></table></div></figure>


<p>We run our tests, it still all works. Now we can just mock out the endpoint
method, and all of our tests on the individual methods become much, much simpler:</p>

<figure role=code><figcaption><span>test/models/notify_via_salmon_test.rb</span></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
<span class='line'>10</span>
<span class='line'>11</span>
<span class='line'>12</span>
<span class='line'>13</span>
<span class='line'>14</span>
<span class='line'>15</span>
<span class='line'>16</span>
<span class='line'>17</span>
<span class='line'>18</span>
<span class='line'>19</span>
<span class='line'>20</span>
<span class='line'>21</span>
<span class='line'>22</span>
<span class='line'>23</span>
<span class='line'>24</span>
<span class='line'>25</span>
<span class='line'>26</span>
<span class='line'>27</span>
<span class='line'>28</span>
<span class='line'>29</span>
<span class='line'>30</span>
<span class='line'>31</span>
<span class='line'>32</span>
<span class='line'>33</span>
<span class='line'>34</span>
<span class='line'>35</span>
<span class='line'>36</span>
<span class='line'>37</span>
<span class='line'>38</span>
<span class='line'>39</span>
<span class='line'>40</span>
<span class='line'>41</span>
<span class='line'>42</span>
<span class='line'>43</span>
<span class='line'>44</span>
<span class='line'>45</span>
</pre></td><td class='code' width='100%'><pre><code class='ruby'><div class='line'><span class="nb">require</span> <span class="s1">&#39;minitest/autorun&#39;</span>
</div><div class='line'><span class="nb">require</span> <span class="s1">&#39;rspec/mocks&#39;</span>
</div><div class='line'><span class="nb">require</span> <span class="s1">&#39;ostatus&#39;</span>
</div><div class='line'>
</div><div class='line'><span class="n">require_relative</span> <span class="s1">&#39;../../app/models/notify_via_salmon&#39;</span>
</div><div class='line'>
</div><div class='line'><span class="n">describe</span> <span class="no">NotifyViaSalmon</span> <span class="k">do</span>
</div><div class='line'>  <span class="n">before</span> <span class="ss">:each</span> <span class="k">do</span>
</div><div class='line'>    <span class="no">RSpec</span><span class="o">::</span><span class="no">Mocks</span><span class="o">::</span><span class="n">setup</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'>
</div><div class='line'>  <span class="n">it</span> <span class="s2">&quot;.mention&quot;</span> <span class="k">do</span>
</div><div class='line'>    <span class="n">user</span> <span class="o">=</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:author</span> <span class="o">=&gt;</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:domain</span> <span class="o">=&gt;</span> <span class="s2">&quot;foo&quot;</span><span class="p">),</span> <span class="ss">:to_rsa_keypair</span> <span class="o">=&gt;</span> <span class="n">stub</span><span class="p">)</span>
</div><div class='line'>    <span class="n">update</span> <span class="o">=</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:to_atom</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</div><div class='line'>    <span class="n">feed</span> <span class="o">=</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:author</span> <span class="o">=&gt;</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:salmon_url</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
</div><div class='line'>
</div><div class='line'>    <span class="no">NotifyViaSalmon</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:send_to_salmon_endpoint</span><span class="p">)</span>
</div><div class='line'>
</div><div class='line'>    <span class="no">NotifyViaSalmon</span><span class="o">.</span><span class="n">mention</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">update</span><span class="p">,</span> <span class="n">feed</span><span class="p">)</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'>
</div><div class='line'>  <span class="n">it</span> <span class="s2">&quot;.follow&quot;</span> <span class="k">do</span>
</div><div class='line'>    <span class="n">user</span> <span class="o">=</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:author</span> <span class="o">=&gt;</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:domain</span> <span class="o">=&gt;</span> <span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="ss">:to_atom</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">),</span> <span class="ss">:to_rsa_keypair</span> <span class="o">=&gt;</span> <span class="n">stub</span><span class="p">)</span>
</div><div class='line'>    <span class="n">feed</span> <span class="o">=</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:author</span> <span class="o">=&gt;</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:salmon_url</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="ss">:to_atom</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
</div><div class='line'>
</div><div class='line'>    <span class="n">salmon</span> <span class="o">=</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:to_xml</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</div><div class='line'>    <span class="no">OStatus</span><span class="o">::</span><span class="no">Salmon</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:from_follow</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="n">salmon</span><span class="p">)</span>
</div><div class='line'>
</div><div class='line'>    <span class="no">NotifyViaSalmon</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:send_to_salmon_endpoint</span><span class="p">)</span>
</div><div class='line'>
</div><div class='line'>    <span class="no">NotifyViaSalmon</span><span class="o">.</span><span class="n">follow</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">feed</span><span class="p">)</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'>
</div><div class='line'>  <span class="n">it</span> <span class="s2">&quot;.unfollow&quot;</span> <span class="k">do</span>
</div><div class='line'>    <span class="n">user</span> <span class="o">=</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:author</span> <span class="o">=&gt;</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:domain</span> <span class="o">=&gt;</span> <span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="ss">:to_atom</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">),</span> <span class="ss">:to_rsa_keypair</span> <span class="o">=&gt;</span> <span class="n">stub</span><span class="p">)</span>
</div><div class='line'>    <span class="n">feed</span> <span class="o">=</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:author</span> <span class="o">=&gt;</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:salmon_url</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="ss">:to_atom</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
</div><div class='line'>
</div><div class='line'>    <span class="n">salmon</span> <span class="o">=</span> <span class="n">stub</span><span class="p">(</span><span class="ss">:to_xml</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</div><div class='line'>    <span class="no">OStatus</span><span class="o">::</span><span class="no">Salmon</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:from_unfollow</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="n">salmon</span><span class="p">)</span>
</div><div class='line'>
</div><div class='line'>    <span class="no">NotifyViaSalmon</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:send_to_salmon_endpoint</span><span class="p">)</span>
</div><div class='line'>
</div><div class='line'>    <span class="no">NotifyViaSalmon</span><span class="o">.</span><span class="n">unfollow</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">feed</span><span class="p">)</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'><span class="k">end</span>
</div></code></pre></td></tr></table></div></figure>


<p>We&#8217;ve managed to get rid of all of the mocking of the URI stuff. It&#8217;s all
details now. We also have great information about what is actually needed for
this test: we know exactly what our objects expect the caller to pass. We&#8217;re
only depending on ourselves and some external libraries. Our tests are fast.
Overall, I&#8217;m feeling much better about this code than I was before.</p>

<h2>In conclusion</h2>

<p>I hope you&#8217;ll take a few things away from this post.</p>

<p><strong>Start with tests first!</strong> If you don&#8217;t do this, it&#8217;s very easy to introduce
simple errors. Don&#8217;t be that guy. You know, the one that has to make <a href="https://github.com/hotsh/rstat.us/pull/398/files">pull requests like this&#8230;</a>
I suck.</p>

<p><strong>Don&#8217;t be afraid to change the tests!</strong> As soon as you&#8217;ve verified that you&#8217;ve
transcribed the code correctly, don&#8217;t be afraid to just nuke things and start
again. Especially if you have integration level tests that confirm that your
features actually <em>work</em>, your unit tests are expendable. If they&#8217;re not useful,
kill them!</p>

<p><strong>Mock like a motherfucker.</strong> When done correctly, mocks allow you to help
design your code better, make your tests fast, and truly isolate the unit under
test. It&#8217;s pretty much all upside, unless you suck at them.</p>

<p><strong>Extract, extract, extract!</strong> Adele Goldberg once said, “In Smalltalk,
everything happens somewhere else.” Make tons of little methods. They help
to provide seams that are useful for testing. Smaller methods are also easier to
understand.</p>

<p><strong>Refactoring is a marathon.</strong> Even with all this work, this code isn&#8217;t the best.
The tests could even use a little TLC. But it&#8217;s still better than it was before.
Those who ship, win. Make things a little better, <code>git commit &amp;&amp; git push</code>, repeat.</p>
</div>
  
  


  </article>

<nav role="pagination">
  <div>
    
      <a class="prev" href="/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</nav>

</div>
<aside role=sidebar>
  
    <aside>
<img src='http://en.gravatar.com/userimage/5335489/ee56a7574df33ed8748160494c930b98.jpg?size=190' />
<h4>Hi there, I&#8217;m Steve.</h4>
<p>
I write both code and prose. Here&#8217;s some of my thoughts about software,
literature, art and code, with some politics thrown in on occasion.
You might also enjoy <a href="http://steveklabnik.com/">my website</a>.
</p>
</aside>

<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2011/11/28/book-review-new-programmers-survival-manual.html">Book Review: New Programmer&#8217;s Survival Manual</a>
      </li>
    
      <li class="post">
        <a href="/2011/11/17/burnout.html">Burnout</a>
      </li>
    
      <li class="post">
        <a href="/2011/10/25/your-startup-is-not-a-platform.html">Your Startup is NOT a Platform</a>
      </li>
    
      <li class="post">
        <a href="/2011/10/19/for-science-im-killing-my-cell-phone.html">For Science: I&#8217;m Killing My Cell Phone</a>
      </li>
    
      <li class="post">
        <a href="/2011/10/04/rubinius-is-awesome.html">Rubinius Is Awesome</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Github Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/steveklabnik">@steveklabnik</a> on Github
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'steveklabnik',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("steveklabnik", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/steveklabnik" class="twitter-follow-button" data-width="208px" data-show-count="false">Follow @steveklabnik</a>
  
</section>




  
</aside>

    </div>
  </div>
  <footer><p>
  Copyright &copy; 2011 - Steve Klabnik -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-10289851-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


  
  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>


  
  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>


</body>
</html>
