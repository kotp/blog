<!DOCTYPE html>
<html lang='en'>
  <head>
    <meta charset='utf8' />
    <title>Steve's Blo</title>
    <link href='/css/site.css' media='screen' rel='stylesheet' type='text/css' />
    <script src='/js/jquery-1.6.min.js' type='text/javascript'></script>
    <script src='/js/app.js' type='text/javascript'></script>
  </head>
  <body>
    <section id='right'>
      <aside>
        <h1>Hi there, I'm Steve.</h1>
        <img src='http://en.gravatar.com/userimage/5335489/ee56a7574df33ed8748160494c930b98.jpg?size=200' />
        <p>I write both code and prose. Here's some of my thoughts about software, literature, art and code, with some politics thrown in on occasion. You might also enjoy <a href="http://steveklabnik.com/">my website</a>.</p>
      </aside>
      <nav>
        <h1>See them all</h1>
        <p>You're viewing a single post, but if you'd like to see the list of everything I've written, just <a href="/">go here</a>.</p>
        <h1>Popular Posts</h1>
        <p>Here are some of my most-viewed articles.</p>
        <ul>
          <li>
            <a href='http://localhost:4000/2010/03/03/why-bother-creating-.html'>Why bother creating?</a>
          </li>
          <li>
            <a href='http://localhost:4000/2010/08/19/a-word-about-why-whyday-and-hackety-hack.html'>A word about _why, #whyday, and Hackety Hack</a>
          </li>
          <li>
            <a href='http://localhost:4000/2010/11/17/the-hardest-decision-i-ve-ever-made-.html'>The hardest decision I've ever made</a>
          </li>
          <li>
            <a href='http://localhost:4000/2010/03/08/create-a-more-compelling-experience-for-your-users-through-game-mechanics.html'>Create a more compelling experience for your users through game mechanics</a>
          </li>
          <li>
            <a href='http://localhost:4000/2010/07/17/what-to-know-before-debating-type-systems.html'>What to know before debating type systems</a>
          </li>
        </ul>
      </nav>
    </section>
    <section id='main'>
      <p>Sometimes, when responding to a support request, it's nice to see what your users see. At the same time, you don't want to ask your users for their passwords, out of respect for their privacy. So what do you do?<p /> Well, *NIX systems have a program called <span style="font-family: courier new, monospace;">su</span>.  Here's what <span style="font-family: courier new, monospace;">man su</span> has to say:</p>
<div> </div>
<div>
<blockquote class="gmail_quote" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0.8ex; border-left-width: 1px; border-left-color: #cccccc; border-left-style: solid; padding-left: 1ex;">NAME</blockquote>
<blockquote class="gmail_quote" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0.8ex; border-left-width: 1px; border-left-color: #cccccc; border-left-style: solid; padding-left: 1ex;">       su - run a shell with substitute user and group IDs</blockquote>
<blockquote class="gmail_quote" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0.8ex; border-left-width: 1px; border-left-color: #cccccc; border-left-style: solid; padding-left: 1ex;"><br /></blockquote>
<blockquote class="gmail_quote" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0.8ex; border-left-width: 1px; border-left-color: #cccccc; border-left-style: solid; padding-left: 1ex;">SYNOPSIS</blockquote>
<blockquote class="gmail_quote" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0.8ex; border-left-width: 1px; border-left-color: #cccccc; border-left-style: solid; padding-left: 1ex;">       su [OPTION]... [-] [USER [ARG]...]</blockquote>
<blockquote class="gmail_quote" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0.8ex; border-left-width: 1px; border-left-color: #cccccc; border-left-style: solid; padding-left: 1ex;"><br /></blockquote>
<blockquote class="gmail_quote" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0.8ex; border-left-width: 1px; border-left-color: #cccccc; border-left-style: solid; padding-left: 1ex;">DESCRIPTION</blockquote>
<blockquote class="gmail_quote" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0.8ex; border-left-width: 1px; border-left-color: #cccccc; border-left-style: solid; padding-left: 1ex;">       Change the effective user id and group id to that of USER.</blockquote>
<div> </div>
<div>
<span style="font-family: courier new, monospace;">su</span> can be thought of as "substitute user" or "switch user." It's a command system administrators use to assume the identity of one of their users, or a way for someone with the root password on the system to switch to the root account itself. So how can we incorporate this into a web application?</div>
<div> </div>
<div>Well, we want to first log ourselves out, and then log in as the user we're <span style="font-family: courier new, monospace;">su</span>-ing to. That's it. The tricky part, however, comes in when we're logging in: as we said before, we don't want to ask for their password. Luckily, Authlogic provides a way to create our UserSession object directly from a User object by just passing it to <span style="font-family: courier new, monospace;">create</span>.</div>
<div> </div>
<div>This lets us write a controller method to do this pretty easily:</div>
<div> </div>
<div>
<blockquote class="gmail_quote" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0.8ex; border-left-width: 1px; border-left-color: #cccccc; border-left-style: solid; padding-left: 1ex;">  def su</blockquote>
<blockquote class="gmail_quote" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0.8ex; border-left-width: 1px; border-left-color: #cccccc; border-left-style: solid; padding-left: 1ex;">    @user = User.find params[:id]</blockquote>
<blockquote class="gmail_quote" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0.8ex; border-left-width: 1px; border-left-color: #cccccc; border-left-style: solid; padding-left: 1ex;">    current_user_session.destroy</blockquote>
<blockquote class="gmail_quote" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0.8ex; border-left-width: 1px; border-left-color: #cccccc; border-left-style: solid; padding-left: 1ex;">    UserSession.create!(@user)</blockquote>
<blockquote class="gmail_quote" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0.8ex; border-left-width: 1px; border-left-color: #cccccc; border-left-style: solid; padding-left: 1ex;">    flash[:notice] = "You've been su-d to that user."</blockquote>
<blockquote class="gmail_quote" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0.8ex; border-left-width: 1px; border-left-color: #cccccc; border-left-style: solid; padding-left: 1ex;">    redirect_to dashboard_path</blockquote>
<blockquote class="gmail_quote" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0.8ex; border-left-width: 1px; border-left-color: #cccccc; border-left-style: solid; padding-left: 1ex;">  end</blockquote>
<div> </div>
<div>Add in a route:</div>
<div> </div>
<blockquote class="gmail_quote" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0.8ex; border-left-width: 1px; border-left-color: #cccccc; border-left-style: solid; padding-left: 1ex;">map.admin_su "/admin/su/:id", :controller =&gt; "admin", :action =&gt; "su"</blockquote>
<div> </div>
<div>And to a view somewhere in your administrative tools:</div>
<div> </div>
<blockquote class="gmail_quote" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0.8ex; border-left-width: 1px; border-left-color: #cccccc; border-left-style: solid; padding-left: 1ex;">&lt;%= link_to "log in as this user", admin_su_path(@user) %&gt;</blockquote>
<div> </div>
<div>And we're good to go!</div>
<div> </div>
<div>One last thing about this, though: You don't want to let anyone who's not an administrator do this, for obvious reasons. My administrative controllers always include a block like this:</div>
<div> </div>
<div>
<blockquote class="gmail_quote" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0.8ex; border-left-width: 1px; border-left-color: #cccccc; border-left-style: solid; padding-left: 1ex;">  access_control do</blockquote>
<blockquote class="gmail_quote" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0.8ex; border-left-width: 1px; border-left-color: #cccccc; border-left-style: solid; padding-left: 1ex;">    allow :admin</blockquote>
<blockquote class="gmail_quote" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0.8ex; border-left-width: 1px; border-left-color: #cccccc; border-left-style: solid; padding-left: 1ex;">  end</blockquote>
<div> </div>
<div>acl9 makes this really easy, but it's really important.</div>
<div> </div>
<div>So there you have it. Easy as pie.</div>
</div>
<div> </div>
<div>EDIT: This post made the Rails subreddit, and <a href="http://www.reddit.com/r/rails/comments/cb0da/writing_a_su_feature_with_authlogic/c0rf26w">brettbender posted his code</a> to get you back to admin. Here it is:</div>
</div>
<div> </div>
<blockquote>
<div><span style="font-family: verdana, arial, helvetica, sans-serif; font-size: small;">
</span><p style="margin-top: 5px; margin-right: 0px; margin-bottom: 5px; margin-left: 0px; padding: 0px;">I used this article to help build a su feature for a rails app I'm working on. thought I would share the code to let you su / exit-su back to the original user you were logged in as. You just need to add a link somewhere persistent if your session contains an entry for :su_user that links to the unsu action.</p>
<p style="margin-top: 5px; margin-right: 0px; margin-bottom: 5px; margin-left: 0px; padding: 0px;">Inside your admin controller, make sure you limit access to these actions:</p>
<div class="CodeRay">
  <div class="code"><pre>def su
  @user = User.find params[:id]

  # change these 3 lines to apply to your session representation 
  session[:su_user] = self.current_user.id
  self.current_user = @user

  flash[:notice] = &quot;You've been logged in as #{@user.login}.&quot;
  redirect_to &quot;/&quot;
end

def unsu    
  redirect_url = &quot;/&quot;
  if(session.has_key?(:su_user))
    self.current_user = User.find session[:su_user]
    session.delete :su_user
    flash[:notice] = &quot;You have exited your switch user session. You are now logged in as #{self.current_user.login}&quot;
    redirect_url = &quot;/admin/users/&quot;
  else
    flash[:error] = &quot;Sorry, we couldn't find your original user.&quot;
  end

  redirect_to redirect_url
end</pre></div>
</div>

</div>
</blockquote>
</div>

    </section>
  </body>
</html>
